{% extends "base.html" %}
{% block title %}Outliers{% endblock %}
{% block page_title %}Outlier Posts{% endblock %}
{% block page_subtitle %}Posts that significantly outperformed their account's average{% endblock %}

{% block content %}

<!-- Filter Bar -->
<div class="filter-bar">
    <div class="filter-group">
        <span class="filter-label">Competitor</span>
        <div class="filter-pills" id="competitor-pills">
            <button class="filter-pill {% if not selected_competitor %}active{% endif %}"
                    onclick="applyFilter('competitor', '')">All</button>
            {% for comp in profile.competitors %}
            {% set comp_handle = comp.handles.get('instagram', comp.handles.get('tiktok', '')) %}
            <button class="filter-pill {% if selected_competitor == comp_handle %}active{% endif %}"
                    onclick="applyFilter('competitor', '{{ comp_handle }}')">
                {{ comp.name }}
            </button>
            {% endfor %}
        </div>
    </div>
    <div class="filter-group">
        <span class="filter-label">Sort</span>
        <div class="filter-pills" id="sort-pills">
            <button class="filter-pill {% if sort_by == 'score' %}active{% endif %}"
                    onclick="applyFilter('sort', 'score')">Score</button>
            <button class="filter-pill {% if sort_by == 'comments' %}active{% endif %}"
                    onclick="applyFilter('sort', 'comments')">Comments</button>
            <button class="filter-pill {% if sort_by == 'saves' %}active{% endif %}"
                    onclick="applyFilter('sort', 'saves')">Saves</button>
            <button class="filter-pill {% if sort_by == 'shares' %}active{% endif %}"
                    onclick="applyFilter('sort', 'shares')">Shares</button>
            <button class="filter-pill {% if sort_by == 'weighted' %}active{% endif %}"
                    onclick="applyFilter('sort', 'weighted')">Weighted</button>
            <button class="filter-pill {% if sort_by == 'date' %}active{% endif %}"
                    onclick="applyFilter('sort', 'date')">Recent</button>
        </div>
    </div>
</div>

<!-- Data Quality Info -->
<div class="data-quality-bar">
    <div class="dq-item">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="5"/><circle cx="12" cy="12" r="5"/><circle cx="17.5" cy="6.5" r="1.5" fill="currentColor"/></svg>
        <span>Instagram</span>
        <span class="dq-metrics">Likes, Comments, Views (Reels), Shares (Reels only)</span>
        <span class="dq-note">Saves are private</span>
    </div>
    <div class="dq-item">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M19.59 6.69a4.83 4.83 0 01-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 01-2.88 2.5 2.89 2.89 0 01-2.89-2.89 2.89 2.89 0 012.89-2.89c.28 0 .54.04.79.1v-3.5a6.37 6.37 0 00-.79-.05A6.34 6.34 0 003.15 15.2a6.34 6.34 0 006.34 6.34 6.34 6.34 0 006.34-6.34V8.51a8.27 8.27 0 004.76 1.5v-3.4a4.85 4.85 0 01-1-.08z"/></svg>
        <span>TikTok</span>
        <span class="dq-metrics">All metrics: Likes, Comments, Saves, Shares, Views, Audio</span>
        <span class="dq-full">Full data</span>
    </div>
</div>

<!-- Results -->
{% if outliers %}
<p class="text-muted mb-16">Showing {{ outliers | length }} outlier posts</p>

<div class="outlier-grid">
    {% for post in outliers %}
    {% set grad_class = "grad-" ~ ((loop.index0 % 5) + 1) %}
    <div class="outlier-card" style="animation-delay: {{ loop.index0 * 0.04 }}s">
        <!-- Gradient Header -->
        <div class="outlier-card-header {{ grad_class }}">
            <div class="header-top">
                <span class="handle-pill">
                    {% if post.platform == 'tiktok' %}
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M19.59 6.69a4.83 4.83 0 01-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 01-2.88 2.5 2.89 2.89 0 01-2.89-2.89 2.89 2.89 0 012.89-2.89c.28 0 .54.04.79.1v-3.5a6.37 6.37 0 00-.79-.05A6.34 6.34 0 003.15 15.2a6.34 6.34 0 006.34 6.34 6.34 6.34 0 006.34-6.34V8.51a8.27 8.27 0 004.76 1.5v-3.4a4.85 4.85 0 01-1-.08z"/></svg>
                    {% else %}
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="5"/><circle cx="12" cy="12" r="5"/><circle cx="17.5" cy="6.5" r="1.5" fill="currentColor"/></svg>
                    {% endif %}
                    @{{ post.competitor_handle }}
                </span>
                {% if post.content_tags %}
                <span class="franchise-tag">{{ post.content_tags[0] }}</span>
                {% endif %}
            </div>
            <div class="header-meta">
                <span class="competitor-label">{{ post.competitor_name }}</span>
                {% if post.posted_at %}
                <span class="post-date">{{ post.posted_at[:10] }}</span>
                {% endif %}
            </div>
        </div>

        <!-- Card Body -->
        <div class="outlier-card-body">
            <!-- Caption + Score Row -->
            <div class="caption-score-row">
                <div class="caption-area">
                    {% if post.caption %}
                    <p class="card-caption">"{{ post.caption[:180] }}{% if post.caption|length > 180 %}...{% endif %}"</p>
                    {% else %}
                    <p class="card-caption text-muted">(No caption)</p>
                    {% endif %}
                </div>
                <div class="eng-score">
                    {% set pct = post.engagement_score_pct %}
                    {% set circ = 251.2 %}
                    {% set offset = circ - (circ * pct / 100) %}
                    {% if pct >= 90 %}{% set ring_class = "ring-cyan" %}
                    {% elif pct >= 75 %}{% set ring_class = "ring-green" %}
                    {% elif pct >= 50 %}{% set ring_class = "ring-yellow" %}
                    {% else %}{% set ring_class = "ring-muted" %}{% endif %}
                    <svg viewBox="0 0 88 88" class="score-svg">
                        <circle class="bg-ring" cx="44" cy="44" r="40"/>
                        <circle class="fg-ring {{ ring_class }}" cx="44" cy="44" r="40"
                                stroke-dasharray="{{ circ }}"
                                stroke-dashoffset="{{ offset }}"
                                style="animation: scoreRing 1s ease-out {{ loop.index0 * 0.08 }}s both"/>
                    </svg>
                    <span class="score-val">{{ pct }}</span>
                </div>
            </div>

            <!-- Audio Tag -->
            {% if post.audio_name %}
            <div class="audio-tag">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
                {{ post.audio_name[:40] }}
            </div>
            {% endif %}

            <!-- Primary Driver -->
            {% if post.primary_driver %}
            <span class="drv drv-{{ post.primary_driver }}">
                {% if post.primary_driver == 'saves' %}Saves-driven
                {% elif post.primary_driver == 'shares' %}Shares-driven
                {% elif post.primary_driver == 'comments' %}Comments-driven
                {% elif post.primary_driver == 'views' %}Views-driven
                {% else %}Likes-driven{% endif %}
            </span>
            {% endif %}

            <!-- Metrics Row (platform-aware: show available data) -->
            <div class="metrics-row">
                {% if post.platform == 'tiktok' %}
                {# TikTok: all metrics available #}
                <div class="m-cell">
                    <span class="m-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 012-2h10a2 2 0 012 2z"/></svg>
                    </span>
                    <span class="m-val">{{ "{:,}".format(post.saves) }}</span>
                    <span class="m-lbl">Saves</span>
                </div>
                <div class="m-cell">
                    <span class="m-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
                    </span>
                    <span class="m-val">{{ "{:,}".format(post.shares) }}</span>
                    <span class="m-lbl">Shares</span>
                </div>
                <div class="m-cell">
                    <span class="m-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                    </span>
                    <span class="m-val">{{ "{:,}".format(post.views) if post.views else "---" }}</span>
                    <span class="m-lbl">Views</span>
                </div>
                {% else %}
                {# Instagram: saves private, shares Reels-only, views for video #}
                <div class="m-cell">
                    <span class="m-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 01-.9 3.8 8.5 8.5 0 01-7.6 4.7 8.38 8.38 0 01-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 01-.9-3.8 8.5 8.5 0 014.7-7.6 8.38 8.38 0 013.8-.9h.5a8.48 8.48 0 018 8v.5z"/></svg>
                    </span>
                    <span class="m-val">{{ "{:,}".format(post.comments) }}</span>
                    <span class="m-lbl">Comments</span>
                </div>
                {% if post.has_shares and post.shares > 0 %}
                <div class="m-cell">
                    <span class="m-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
                    </span>
                    <span class="m-val">{{ "{:,}".format(post.shares) }}</span>
                    <span class="m-lbl">Shares</span>
                </div>
                {% endif %}
                {% if post.has_views and post.views > 0 %}
                <div class="m-cell">
                    <span class="m-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                    </span>
                    <span class="m-val">{{ "{:,}".format(post.views) }}</span>
                    <span class="m-lbl">Views</span>
                </div>
                {% endif %}
                {% if post.has_saves and post.saves > 0 %}
                <div class="m-cell">
                    <span class="m-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 012-2h10a2 2 0 012 2z"/></svg>
                    </span>
                    <span class="m-val">{{ "{:,}".format(post.saves) }}</span>
                    <span class="m-lbl">Saves</span>
                </div>
                {% endif %}
                {% endif %}
            </div>
        </div>

        <!-- Card Footer -->
        <div class="outlier-card-ft">
            <div class="sec-metrics">
                <span title="Likes">
                    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></svg>
                    {{ "{:,}".format(post.likes) }}
                </span>
                <span title="Comments">
                    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
                    {{ "{:,}".format(post.comments) }}
                </span>
                <span class="badge badge-neutral" style="font-size:11px;">{{ post.media_type }}</span>
            </div>
            {% if post.post_url %}
            <a href="{{ post.post_url }}" target="_blank" rel="noopener" class="view-link">
                View
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
            </a>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

{% else %}
<div class="card">
    <div class="empty-state">
        <div class="empty-state-icon">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.5"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
        </div>
        <h3>No outliers found yet</h3>
        <p>Outliers appear after running the pipeline at least once. The engine needs a few posts per competitor to establish baselines before it can detect what's unusual.</p>
        <form method="POST" action="{{ url_for('run_engine') }}">
            <button type="submit" class="btn btn-primary">Run Pipeline Now</button>
        </form>
    </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
function applyFilter(key, value) {
    const url = new URL(window.location.href);
    url.searchParams.set(key, value);
    window.location.href = url.toString();
}
</script>
{% endblock %}
