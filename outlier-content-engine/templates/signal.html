<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>Signal AI - Outlier Content</title>
    <link rel="stylesheet" href="/static/signal-ai.css">
</head>
<body>

<div class="signal-split">
    <!-- ========== LEFT PANEL: CHAT ========== -->
    <div class="signal-chat-panel">
        <!-- Chat Header -->
        <div class="signal-chat-header">
            <div class="signal-brand">
                <div class="signal-brand-icon">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <polygon points="12 2 22 8.5 22 15.5 12 22 2 15.5 2 8.5 12 2"/>
                    </svg>
                </div>
                <span class="signal-brand-name">Signal AI</span>
            </div>
            <p class="signal-chat-subtitle">Outlier Content ¬∑ {{ outliers|length if outliers else 0 }} posts</p>
        </div>

        <!-- Chat Messages -->
        <div class="signal-messages" id="chatMessages">
            <!-- Welcome Message -->
            <div class="signal-message">
                <div class="signal-avatar">S</div>
                <div class="signal-message-content">
                    <div class="signal-message-bubble">
                        Welcome back. I've been monitoring your sector. Which brand or competitor set should we analyze today?
                    </div>
                    <div class="signal-message-time">Just now</div>
                </div>
            </div>

            <!-- Competitive Set Display -->
            {% if competitive_set %}
            <div class="signal-message">
                <div class="signal-avatar">S</div>
                <div class="signal-message-content">
                    <div class="signal-message-bubble">
                        Currently tracking {{ competitive_set|length }} brands in {{ vertical_name }}:
                        {% for brand in competitive_set %}
                            {%- if brand.instagram_handle -%}
                                @{{ brand.instagram_handle }}
                            {%- elif brand.tiktok_handle -%}
                                @{{ brand.tiktok_handle }}
                            {%- elif brand.brand_name -%}
                                {{ brand.brand_name }}
                            {%- endif -%}
                            {%- if not loop.last %}, {% endif -%}
                        {% endfor %}
                    </div>
                    <div class="signal-message-time">Active competitors</div>
                </div>
            </div>
            {% endif %}

            <!-- Analysis Summary (if insights exist) -->
            {% if insights and insights.has_insights %}
            <div class="signal-message">
                <div class="signal-avatar">S</div>
                <div class="signal-message-content">
                    <div class="signal-message-bubble">
                        {{ insights.summary }}
                    </div>

                    <!-- Pattern Cards -->
                    {% for pattern in insights.patterns[:3] %}
                    <div class="signal-insight-card">
                        <div class="signal-insight-header">
                            <span class="signal-insight-icon">
                                {% if pattern.pattern_type == 'driver' %}
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--signal-cyan)" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>
                                {% elif pattern.pattern_type == 'format' %}
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--signal-cyan)" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="2"/><line x1="8" y1="2" x2="8" y2="22"/></svg>
                                {% else %}
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--signal-cyan)" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                                {% endif %}
                            </span>
                            <span class="signal-insight-label">{{ pattern.pattern_type|upper }}</span>
                            <span class="signal-insight-metric">{{ pattern.metric }}</span>
                        </div>
                        <div class="signal-insight-title">{{ pattern.name }}</div>
                        <div class="signal-insight-desc">{{ pattern.description }}</div>
                        {% if pattern.actionable_takeaway %}
                        <div class="signal-insight-action">{{ pattern.actionable_takeaway }}</div>
                        {% endif %}
                    </div>
                    {% endfor %}

                    <!-- Recommendations -->
                    {% if insights.recommendations %}
                    <div class="signal-insight-card signal-rec-card">
                        <div class="signal-insight-header">
                            <span class="signal-insight-icon">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--signal-success)" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                            </span>
                            <span class="signal-insight-label">WHAT TO DO NEXT</span>
                        </div>
                        {% for rec in insights.recommendations[:2] %}
                        <div class="signal-rec-item">
                            <div class="signal-insight-title">{{ rec.title }}</div>
                            <div class="signal-insight-desc">{{ rec.description }}</div>
                            <ul class="signal-rec-actions">
                                {% for action in rec.actions[:3] %}
                                <li>{{ action }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <!-- Franchise Cards -->
                    {% for franchise in insights.franchises[:1] %}
                    <div class="signal-insight-card">
                        <div class="signal-insight-header">
                            <span class="signal-insight-icon">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--signal-tag-purple)" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2"/></svg>
                            </span>
                            <span class="signal-insight-label">FRANCHISE</span>
                            <span class="signal-insight-metric">{{ franchise.retention_score }}</span>
                        </div>
                        <div class="signal-insight-title">{{ franchise.name }}</div>
                        <div class="signal-insight-desc">{{ franchise.description }}</div>
                    </div>
                    {% endfor %}

                    <div class="signal-message-time">{{ insights.outlier_count }} outliers analyzed</div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Chat Input -->
        <div class="signal-chat-input-area">
            <input
                type="text"
                class="signal-chat-input"
                id="chatInput"
                placeholder="Ask about your competitors..."
                autocomplete="off"
            >
        </div>
    </div>

    <!-- ========== RIGHT PANEL: CONTENT ========== -->
    <div class="signal-content-panel">
        <!-- Content Header -->
        <div class="signal-content-header">
            <div class="signal-title-row">
                <h1 class="signal-content-title">Outlier Content</h1>
            </div>

            <!-- Filter Pills -->
            <div class="signal-filters">
                <!-- Brands Filter (with manage link) -->
                {% if competitive_set %}
                <div class="signal-filter-group">
                    <span class="signal-filter-label">BRANDS
                        <a href="/verticals/{{ vertical_name }}/edit" class="signal-filter-manage" title="Manage brands">
                            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
                                <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                        </a>
                    </span>
                    <div class="signal-filter-pills">
                        <button class="signal-pill {% if not selected_competitor %}active{% endif %}"
                                onclick="applyFilter('competitor', '')">All ({{ competitive_set|length }})</button>
                        {% for brand in competitive_set %}
                            {% set handle = brand.instagram_handle or brand.tiktok_handle or '' %}
                            {% if handle %}
                            <button class="signal-pill {% if selected_competitor == handle %}active{% endif %}"
                                    onclick="applyFilter('competitor', '{{ handle }}')">
                                @{{ handle }}
                            </button>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Platform Filter -->
                <div class="signal-filter-group">
                    <span class="signal-filter-label">PLATFORM</span>
                    <div class="signal-filter-pills">
                        <button class="signal-pill {% if not selected_platform %}active{% endif %}"
                                onclick="applyFilter('platform', '')">All</button>
                        <button class="signal-pill {% if selected_platform == 'instagram' %}active{% endif %}"
                                onclick="applyFilter('platform', 'instagram')">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="2" y="2" width="20" height="20" rx="5"/>
                                <circle cx="12" cy="12" r="5"/>
                                <circle cx="17.5" cy="6.5" r="1.5" fill="currentColor"/>
                            </svg>
                            IG
                        </button>
                        <button class="signal-pill {% if selected_platform == 'tiktok' %}active{% endif %}"
                                onclick="applyFilter('platform', 'tiktok')">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19.59 6.69a4.83 4.83 0 01-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 01-2.88 2.5 2.89 2.89 0 01-2.89-2.89 2.89 2.89 0 012.89-2.89c.28 0 .54.04.79.1v-3.5a6.37 6.37 0 00-.79-.05A6.34 6.34 0 003.15 15.2a6.34 6.34 0 006.34 6.34 6.34 6.34 0 006.34-6.34V8.51a8.27 8.27 0 004.76 1.5v-3.4a4.85 4.85 0 01-1-.08z"/>
                            </svg>
                            TT
                        </button>
                    </div>
                </div>

                <!-- Timeframe Filter -->
                <div class="signal-filter-group">
                    <span class="signal-filter-label">TIMEFRAME</span>
                    <div class="signal-filter-pills">
                        <button class="signal-pill {% if not selected_timeframe %}active{% endif %}"
                                onclick="applyFilter('timeframe', '')">All</button>
                        <button class="signal-pill {% if selected_timeframe == '30d' %}active{% endif %}"
                                onclick="applyFilter('timeframe', '30d')">30d</button>
                        <button class="signal-pill {% if selected_timeframe == '90d' %}active{% endif %}"
                                onclick="applyFilter('timeframe', '90d')">3mo</button>
                        <button class="signal-pill {% if selected_timeframe == '180d' %}active{% endif %}"
                                onclick="applyFilter('timeframe', '180d')">6mo</button>
                        <button class="signal-pill {% if selected_timeframe == '365d' %}active{% endif %}"
                                onclick="applyFilter('timeframe', '365d')">1yr</button>
                    </div>
                </div>

                <!-- Sort Filter -->
                <div class="signal-filter-group">
                    <span class="signal-filter-label">SORT</span>
                    <div class="signal-filter-pills">
                        <button class="signal-pill {% if sort_by == 'score' %}active{% endif %}"
                                onclick="applyFilter('sort', 'score')">Score</button>
                        <button class="signal-pill {% if sort_by == 'saves' %}active{% endif %}"
                                onclick="applyFilter('sort', 'saves')">Saves</button>
                        <button class="signal-pill {% if sort_by == 'shares' %}active{% endif %}"
                                onclick="applyFilter('sort', 'shares')">Shares</button>
                        <button class="signal-pill {% if sort_by == 'date' %}active{% endif %}"
                                onclick="applyFilter('sort', 'date')">Recent</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content Grid -->
        <div class="signal-grid">
            {% if outliers %}
                {% for post in outliers %}
                <a href="{{ post.post_url }}" target="_blank" rel="noopener noreferrer" class="signal-card-link">
                    <div class="signal-card" style="animation-delay: {{ loop.index0 * 0.05 }}s">
                        <!-- Card Media -->
                    <div class="signal-card-media">
                        <!-- Post Image/Video with smart fallback chain -->
                        {% set grad_name = ['purple', 'green', 'orange', 'pink', 'teal'][loop.index0 % 5] %}
                        {% if post.media_url %}
                            {% if post.media_type == 'video' and post.platform == 'tiktok' %}
                            <img src="/proxy-image?url={{ post.media_url|urlencode }}" alt="{{ post.competitor_name }} post" loading="lazy"
                                 data-platform="{{ post.platform }}" data-postid="{{ post.post_id }}" data-handle="{{ post.competitor_handle }}"
                                 onerror="handleImageError(this, '{{ grad_name }}')">
                            {% else %}
                            <img src="/proxy-image?url={{ post.media_url|urlencode }}" alt="{{ post.competitor_name }} post" loading="lazy"
                                 data-platform="{{ post.platform }}" data-postid="{{ post.post_id }}" data-handle="{{ post.competitor_handle }}"
                                 onerror="handleImageError(this, '{{ grad_name }}')">
                            {% endif %}
                        {% else %}
                            <img src="https://www.instagram.com/p/{{ post.post_id }}/media/?size=l" alt="{{ post.competitor_name }} post" loading="lazy"
                                 data-platform="{{ post.platform }}" data-postid="{{ post.post_id }}" data-handle="{{ post.competitor_handle }}"
                                 onerror="handleImageError(this, '{{ grad_name }}')"
                                 style="{% if post.platform == 'tiktok' %}display:none{% endif %}">
                            {% if post.platform == 'tiktok' %}
                            <div class="signal-gradient-{{ grad_name }}"></div>
                            {% endif %}
                        {% endif %}
                        <!-- Gradient fallback (hidden until needed) -->
                        <div class="signal-gradient-{{ grad_name }} signal-fallback-gradient" style="display:none;">
                            <div class="signal-fallback-info">
                                <span class="signal-fallback-handle">@{{ post.competitor_handle }}</span>
                                <span class="signal-fallback-type">{{ post.media_type|upper }}</span>
                                {% if post.likes %}
                                <span class="signal-fallback-stat">{{ "{:,}".format(post.likes) }} likes</span>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Platform Badge (Top-Left) -->
                        <div class="signal-platform-badge">
                            {% if post.platform == 'tiktok' %}
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19.59 6.69a4.83 4.83 0 01-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 01-2.88 2.5 2.89 2.89 0 01-2.89-2.89 2.89 2.89 0 012.89-2.89c.28 0 .54.04.79.1v-3.5a6.37 6.37 0 00-.79-.05A6.34 6.34 0 003.15 15.2a6.34 6.34 0 006.34 6.34 6.34 6.34 0 006.34-6.34V8.51a8.27 8.27 0 004.76 1.5v-3.4a4.85 4.85 0 01-1-.08z"/>
                            </svg>
                            {% else %}
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="2" y="2" width="20" height="20" rx="5"/>
                                <circle cx="12" cy="12" r="5"/>
                                <circle cx="17.5" cy="6.5" r="1.5" fill="currentColor"/>
                            </svg>
                            {% endif %}
                            @{{ post.competitor_handle }}
                        </div>

                        <!-- Date Badge (Below Platform Badge) -->
                        {% if post.posted_at %}
                        <div class="signal-date-badge">
                            {{ post.posted_at|timeago }}
                        </div>
                        {% endif %}

                        <!-- Category Tags (Top-Right) -->
                        {% if post.content_tags %}
                        <div class="signal-tags">
                            {% for tag in post.content_tags[:3] %}
                            <span class="signal-tag signal-tag-{{ loop.index0 % 5 }}">{{ tag }}</span>
                            {% endfor %}
                        </div>
                        {% endif %}

                        <!-- Score Ring (Bottom-Right) -->
                        <div class="signal-score-ring">
                            {% set pct = post.engagement_score_pct %}
                            {% set circ = 251.2 %}
                            {% set offset = circ - (circ * pct / 100) %}
                            {% if pct >= 90 %}{% set ring_class = "cyan" %}
                            {% elif pct >= 75 %}{% set ring_class = "green" %}
                            {% elif pct >= 50 %}{% set ring_class = "yellow" %}
                            {% else %}{% set ring_class = "dim" %}{% endif %}

                            <svg viewBox="0 0 88 88" class="signal-score-svg">
                                <circle class="signal-score-bg" cx="44" cy="44" r="40"/>
                                <circle class="signal-score-fg {{ ring_class }}" cx="44" cy="44" r="40"
                                        stroke-dasharray="{{ circ }}"
                                        stroke-dashoffset="{{ offset }}"/>
                            </svg>
                            <span class="signal-score-value">{{ pct }}</span>
                        </div>
                    </div>

                    <!-- Card Body -->
                    <div class="signal-card-body">
                        <!-- Per-Post Insight: Why It Worked -->
                        {% if insights and insights.post_insights and post.post_id in insights.post_insights %}
                        {% set pi = insights.post_insights[post.post_id] %}
                        {% if pi.why_it_worked %}
                        <div class="signal-card-insight">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="var(--signal-cyan)" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                            <span>{{ pi.why_it_worked[0][:120] }}{% if pi.why_it_worked[0]|length > 120 %}...{% endif %}</span>
                        </div>
                        {% endif %}
                        {% endif %}

                        <!-- Caption -->
                        {% if post.caption %}
                        <p class="signal-card-caption">"{{ post.caption[:150] }}{% if post.caption|length > 150 %}...{% endif %}"</p>
                        {% else %}
                        <p class="signal-card-caption" style="opacity: 0.5;">(No caption)</p>
                        {% endif %}

                        <!-- Stats -->
                        <div class="signal-card-stats">
                            <div class="signal-stat">
                                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/>
                                </svg>
                                {{ "{:,}".format(post.likes) if post.likes else '0' }}
                            </div>
                            <div class="signal-stat">
                                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>
                                </svg>
                                {{ "{:,}".format(post.comments) if post.comments else '0' }}
                            </div>
                            {% if post.saves %}
                            <div class="signal-stat">
                                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M19 21l-7-5-7 5V5a2 2 0 012-2h10a2 2 0 012 2z"/>
                                </svg>
                                {{ "{:,}".format(post.saves) }}
                            </div>
                            {% endif %}
                            {% if post.shares %}
                            <div class="signal-stat">
                                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8"/>
                                    <polyline points="16 6 12 2 8 6"/>
                                    <line x1="12" y1="2" x2="12" y2="15"/>
                                </svg>
                                {{ "{:,}".format(post.shares) }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    </div>
                </a>
                {% endfor %}
            {% else %}
                <!-- Empty State -->
                <div class="signal-empty">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="M21 21l-4.35-4.35"></path>
                    </svg>
                    <h3>No outlier posts found</h3>
                    <p>Run an analysis to find viral content from your competitors.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Image fallback chain: proxy -> Instagram embed thumbnail -> gradient
function handleImageError(img, gradientName) {
    const platform = img.dataset.platform;
    const postId = img.dataset.postid;
    const retryAttempt = parseInt(img.dataset.retry || '0');

    if (retryAttempt === 0 && platform === 'instagram' && postId) {
        // Try Instagram's public embed media endpoint
        img.dataset.retry = '1';
        img.src = `https://www.instagram.com/p/${postId}/media/?size=l`;
        return;
    }

    // All retries exhausted ‚Äî show gradient fallback
    img.style.display = 'none';
    const fallback = img.closest('.signal-card-media').querySelector('.signal-fallback-gradient');
    if (fallback) {
        fallback.style.display = 'flex';
    }
}

// Filter handling
function applyFilter(key, value) {
    const url = new URL(window.location.href);
    url.searchParams.set(key, value);
    window.location.href = url.toString();
}

// Pattern filtering
function filterByPattern(patternName) {
    applyFilter('tag', patternName);
}

// Chat input handling
const chatInput = document.getElementById('chatInput');
if (chatInput) {
    chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && chatInput.value.trim()) {
            sendChatMessage(chatInput.value.trim());
            chatInput.value = '';
        }
    });
}

async function sendChatMessage(message) {
    // Add user message first
    addChatMessage(message, true);

    try {
        const response = await fetch('/chat/message', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message })
        });

        const data = await response.json();

        // Handle different response types
        if (data.type === 'category_card') {
            addCategoryCard(data.response, data.data, data.actions);
        } else if (data.type === 'category_list') {
            addCategoryList(data.response, data.data);
        } else if (data.response) {
            addChatMessage(data.response, false);
        }
    } catch (error) {
        console.error('Chat error:', error);
        addChatMessage('Sorry, there was an error processing your message.', false);
    }
}

function addChatMessage(text, isUser) {
    const messagesDiv = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = isUser ? 'signal-message signal-message-user' : 'signal-message';

    const avatar = document.createElement('div');
    avatar.className = 'signal-avatar';
    avatar.textContent = isUser ? 'U' : 'S';

    if (isUser) {
        avatar.style.background = 'var(--signal-cyan)';
        avatar.style.color = '#000';
    }

    const content = document.createElement('div');
    content.className = 'signal-message-content';

    const bubble = document.createElement('div');
    bubble.className = 'signal-message-bubble';
    bubble.textContent = text;

    if (isUser) {
        bubble.style.background = 'var(--signal-cyan-dim)';
        bubble.style.border = '1px solid var(--signal-cyan)';
        bubble.style.color = 'var(--signal-text-primary)';
    }

    const timeDiv = document.createElement('div');
    timeDiv.className = 'signal-message-time';
    timeDiv.textContent = 'Just now';

    content.appendChild(bubble);
    content.appendChild(timeDiv);
    messageDiv.appendChild(avatar);
    messageDiv.appendChild(content);
    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function addCategoryCard(text, data, actions) {
    const messagesDiv = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'signal-message';

    const avatar = document.createElement('div');
    avatar.className = 'signal-avatar';
    avatar.textContent = 'S';

    const content = document.createElement('div');
    content.className = 'signal-message-content';

    // Text bubble
    const bubble = document.createElement('div');
    bubble.className = 'signal-message-bubble';
    bubble.textContent = text;
    content.appendChild(bubble);

    // Category card
    const card = document.createElement('div');
    card.className = 'signal-insight-card';
    card.style.marginTop = '12px';

    const header = document.createElement('div');
    header.className = 'signal-insight-header';
    header.innerHTML = `
        <span class="signal-insight-icon">üìÅ</span>
        <span class="signal-insight-label">COLLECTION</span>
        <span class="signal-insight-metric">${data.brand_count} brand${data.brand_count !== 1 ? 's' : ''}</span>
    `;
    card.appendChild(header);

    const title = document.createElement('div');
    title.className = 'signal-insight-title';
    title.textContent = data.name;
    card.appendChild(title);

    const brandsDiv = document.createElement('div');
    brandsDiv.className = 'signal-insight-desc';
    brandsDiv.style.display = 'flex';
    brandsDiv.style.flexWrap = 'wrap';
    brandsDiv.style.gap = '8px';
    brandsDiv.style.marginTop = '12px';

    data.brands.forEach(handle => {
        const brandTag = document.createElement('span');
        brandTag.style.cssText = 'background: var(--signal-bg-tertiary); color: var(--signal-text-secondary); padding: 4px 10px; border-radius: 6px; font-size: 12px;';
        brandTag.textContent = handle;
        brandsDiv.appendChild(brandTag);
    });
    card.appendChild(brandsDiv);

    // Action buttons
    if (actions && actions.length > 0) {
        const actionsDiv = document.createElement('div');
        actionsDiv.style.cssText = 'display: flex; gap: 8px; margin-top: 12px;';

        actions.forEach(action => {
            const btn = document.createElement('button');
            btn.className = 'signal-pill';
            btn.textContent = action.label;
            btn.onclick = () => {
                if (action.action === 'run_analysis') {
                    sendChatMessage(`run analysis for ${action.category}`);
                } else if (action.action === 'add_brands') {
                    chatInput.value = `add @brand to ${action.category}`;
                    chatInput.focus();
                }
            };
            actionsDiv.appendChild(btn);
        });

        card.appendChild(actionsDiv);
    }

    content.appendChild(card);

    const timeDiv = document.createElement('div');
    timeDiv.className = 'signal-message-time';
    timeDiv.textContent = 'Just now';
    content.appendChild(timeDiv);

    messageDiv.appendChild(avatar);
    messageDiv.appendChild(content);
    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function addCategoryList(text, categories) {
    const messagesDiv = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'signal-message';

    const avatar = document.createElement('div');
    avatar.className = 'signal-avatar';
    avatar.textContent = 'S';

    const content = document.createElement('div');
    content.className = 'signal-message-content';

    const bubble = document.createElement('div');
    bubble.className = 'signal-message-bubble';
    bubble.textContent = text;
    content.appendChild(bubble);

    // Category list
    categories.forEach(cat => {
        const catCard = document.createElement('div');
        catCard.className = 'signal-insight-card';
        catCard.style.marginTop = '12px';
        catCard.style.cursor = 'pointer';
        catCard.onclick = () => sendChatMessage(`show ${cat.name}`);

        const header = document.createElement('div');
        header.className = 'signal-insight-header';
        header.innerHTML = `
            <span class="signal-insight-icon">üìÅ</span>
            <span class="signal-insight-label">${cat.name.toUpperCase()}</span>
            <span class="signal-insight-metric">${cat.brand_count} brand${cat.brand_count !== 1 ? 's' : ''}</span>
        `;
        catCard.appendChild(header);

        content.appendChild(catCard);
    });

    const timeDiv = document.createElement('div');
    timeDiv.className = 'signal-message-time';
    timeDiv.textContent = 'Just now';
    content.appendChild(timeDiv);

    messageDiv.appendChild(avatar);
    messageDiv.appendChild(content);
    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// Auto-scroll messages
const messagesContainer = document.getElementById('chatMessages');
if (messagesContainer) {
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}
</script>

</body>
</html>
