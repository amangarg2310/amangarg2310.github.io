<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>ScoutAI - Outliers Identified</title>
    <link rel="stylesheet" href="/static/signal-ai.css">
</head>
<body>

<!-- Splash Screen (First Visit Only) -->
<div id="splashScreen" class="splash-screen" style="display: none;">
    <div class="splash-content">
        <div class="splash-logo">
            <img src="/static/scoutai-logo-white-trimmed.svg" alt="ScoutAI" style="height: 150px; width: auto;">
        </div>
        <p class="splash-tagline">Discover What's Working in Social Media</p>
        <div class="splash-loader">
            <div class="splash-loader-bar"></div>
        </div>
    </div>
</div>

<div class="signal-split">
    <!-- ========== LEFT PANEL: CHAT ========== -->
    <div class="signal-chat-panel">
        <!-- Chat Header -->
        <div class="signal-chat-header">
            <div class="signal-brand">
                <img src="/static/scoutai-logo-white-trimmed.svg" alt="ScoutAI" style="height: 90px; width: auto;">
            </div>
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <p class="signal-chat-subtitle">Outliers Identified: {{ outliers|length if outliers else 0 }} posts
                    <span class="signal-timeframe-context">
                        {% if selected_timeframe == '3mo' %}
                            — scored vs each brand's 3-month baseline
                        {% else %}
                            — scored vs each brand's 30-day baseline
                        {% endif %}
                    </span>
                </p>
                <button class="signal-chat-reset" onclick="resetChat()" title="Reset conversation">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="1 4 1 10 7 10"></polyline>
                        <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
                    </svg>
                    Reset
                </button>
            </div>
        </div>

        <!-- Chat Messages -->
        <div class="signal-messages" id="chatMessages">
            <!-- Welcome / Onboarding Message -->
            {% if needs_setup %}
            <div id="setupPrompt">
            <div class="signal-message">
                <div class="signal-avatar">S</div>
                <div class="signal-message-content">
                    <div class="signal-message-bubble">
                        Hey! Welcome to ScoutAI. I find viral social media posts by tracking your competitors.
                        <br><br>
                        To get started, I need two API keys:
                        <br><strong>1.</strong> <strong>Apify</strong> — for collecting Instagram/TikTok posts
                        <br><strong>2.</strong> <strong>OpenAI</strong> — for AI-powered content analysis
                        <br><br>
                        It takes about 2 minutes to set up.
                    </div>
                    <div class="signal-message-time">Just now</div>
                </div>
            </div>
            <div class="signal-message">
                <div class="signal-avatar">S</div>
                <div class="signal-message-content">
                    <div class="signal-onboarding-cta">
                        <a href="{{ url_for('setup_page') }}" class="signal-setup-btn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 5v14M5 12h14"/>
                            </svg>
                            Set up API keys
                        </a>
                        <span class="signal-onboarding-hint">Free tiers available for both services</span>
                    </div>
                </div>
            </div>
            </div>
            <!-- Fallback welcome shown when BYOK keys exist in localStorage -->
            <div id="byokWelcome" style="display:none;">
            <div class="signal-message">
                <div class="signal-avatar">S</div>
                <div class="signal-message-content">
                    <div class="signal-message-bubble">
                        Hey! Welcome to ScoutAI. I find viral social media posts by tracking your competitors.
                        <br><br>
                        Your API keys are configured. Let's create your first competitive set — pick a template below or describe your niche:
                    </div>
                    <div class="signal-message-time">Just now</div>
                </div>
            </div>
            </div>
            {% elif not saved_verticals %}
            <div class="signal-message">
                <div class="signal-avatar">S</div>
                <div class="signal-message-content">
                    <div class="signal-message-bubble">
                        You're all set! Let's create your first competitive set. Pick a template or describe your niche:
                    </div>
                    <div class="signal-message-time">Just now</div>
                </div>
            </div>
            <div class="signal-message">
                <div class="signal-avatar">S</div>
                <div class="signal-message-content">
                    <div class="signal-onboarding-templates">
                        <div class="signal-template-card" onclick="useTemplate('Streetwear', '@supremenewyork @kaboreitokyo @stussy @palaceskateboards @noahclothing')">
                            <div class="signal-template-icon">&#128085;</div>
                            <div class="signal-template-info">
                                <div class="signal-template-name">Streetwear</div>
                                <div class="signal-template-brands">Supreme, Kith, Stussy, Palace, Noah</div>
                            </div>
                        </div>
                        <div class="signal-template-card" onclick="useTemplate('Beauty & Skincare', '@glossier @theordinary @fentybeauty @rfrfrfrfrf @milkmakeup')">
                            <div class="signal-template-icon">&#10024;</div>
                            <div class="signal-template-info">
                                <div class="signal-template-name">Beauty & Skincare</div>
                                <div class="signal-template-brands">Glossier, The Ordinary, Fenty, Rhode, Milk</div>
                            </div>
                        </div>
                        <div class="signal-template-card" onclick="useTemplate('Fitness & Wellness', '@gymshark @lululemon @nike @aloyoga @outdoorvoices')">
                            <div class="signal-template-icon">&#128170;</div>
                            <div class="signal-template-info">
                                <div class="signal-template-name">Fitness & Wellness</div>
                                <div class="signal-template-brands">Gymshark, Lululemon, Nike, Alo, Outdoor Voices</div>
                            </div>
                        </div>
                        <div class="signal-template-card" onclick="useTemplate('Food & Beverage', '@chipotle @sweetgreen @liquid.death @poppi @olipop')">
                            <div class="signal-template-icon">&#127828;</div>
                            <div class="signal-template-info">
                                <div class="signal-template-name">Food & Beverage</div>
                                <div class="signal-template-brands">Chipotle, Sweetgreen, Liquid Death, Poppi, Olipop</div>
                            </div>
                        </div>
                        <div class="signal-template-card signal-template-custom" onclick="openCreateModal()">
                            <div class="signal-template-icon">&#43;</div>
                            <div class="signal-template-info">
                                <div class="signal-template-name">Custom</div>
                                <div class="signal-template-brands">Start from scratch with your own brands</div>
                            </div>
                        </div>
                    </div>
                    <div class="signal-onboarding-hint" style="margin-top:10px;">
                        Or type something like: <code>"Create a Streetwear set with @nike and @adidas"</code>
                    </div>
                </div>
            </div>
            {% else %}
            {% if chat_history %}
            <!-- Re-render prior conversation so chat doesn't appear to reset on page reload -->
            {% for msg in chat_history %}
            <div class="signal-message {% if msg.role == 'user' %}signal-message-user{% endif %}">
                <div class="signal-avatar">{% if msg.role == 'user' %}{{ session.get('user', {}).get('name', 'You')[0]|upper if session.get('user') else 'Y' }}{% else %}S{% endif %}</div>
                <div class="signal-message-content">
                    <div class="signal-message-bubble">{{ msg.content }}</div>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="signal-message">
                <div class="signal-avatar">S</div>
                <div class="signal-message-content">
                    <div class="signal-message-bubble">
                        Welcome back. Which brand or competitor set should we analyze today?
                    </div>
                    <div class="signal-message-time">Just now</div>
                </div>
            </div>
            {% endif %}
            {% endif %}

            <!-- Competitive Set Display -->
            {% if competitive_set %}
            <div class="signal-message">
                <div class="signal-avatar">S</div>
                <div class="signal-message-content">
                    <div class="signal-message-bubble">
                        Currently tracking {{ competitive_set|length }} brands in {{ vertical_name }}:
                        {% for brand in competitive_set %}
                            {%- if brand.instagram_handle -%}
                                @{{ brand.instagram_handle }}
                            {%- elif brand.tiktok_handle -%}
                                @{{ brand.tiktok_handle }}
                            {%- elif brand.brand_name -%}
                                {{ brand.brand_name }}
                            {%- endif -%}
                            {%- if not loop.last %}, {% endif -%}
                        {% endfor %}
                    </div>
                    <div class="signal-message-time">Active competitors</div>
                </div>
            </div>
            {% endif %}

            <!-- Brand Baselines (Competitor Benchmarking) -->
            {% if brand_baselines %}
            <div class="signal-message">
                <div class="signal-avatar">S</div>
                <div class="signal-message-content">
                    <div class="signal-benchmark-trigger" onclick="toggleBenchmarks(this)">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--signal-cyan)" stroke-width="2"><rect x="2" y="10" width="4" height="12"/><rect x="10" y="4" width="4" height="18"/><rect x="18" y="8" width="4" height="14"/></svg>
                        <span>Brand Baselines</span>
                        <span class="signal-benchmark-count">{{ brand_baselines|length }} brands</span>
                        <svg class="signal-benchmark-chevron" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                    </div>
                    <div class="signal-benchmark-panel">
                        <div class="signal-benchmark-header-row">
                            <span class="signal-benchmark-col-label">Brand</span>
                            <span class="signal-benchmark-col-label">Avg Likes</span>
                            <span class="signal-benchmark-col-label">Avg Comments</span>
                            <span class="signal-benchmark-col-label">Posts</span>
                        </div>
                        {% for bl in brand_baselines %}
                        <div class="signal-benchmark-row">
                            <span class="signal-benchmark-handle">
                                @{{ bl.competitor_handle }}
                                {% set ns = namespace(has_error=false) %}
                                {% for err in collection_errors %}
                                {% if '@' + bl.competitor_handle in err %}
                                {% set ns.has_error = true %}
                                {% endif %}
                                {% endfor %}
                                {% if ns.has_error %}
                                <span class="signal-benchmark-error-badge" title="Collection error on last run">!</span>
                                {% elif bl.post_count == 0 %}
                                <span class="signal-benchmark-warn-badge" title="No posts collected">0</span>
                                {% endif %}
                                {% if bl.outlier_count %}
                                <span class="signal-benchmark-outlier-badge">{{ bl.outlier_count }}</span>
                                {% endif %}
                            </span>
                            <span class="signal-benchmark-val">{{ "{:,.0f}".format(bl.mean_likes) }}</span>
                            <span class="signal-benchmark-val">{{ "{:,.0f}".format(bl.mean_comments) }}</span>
                            <span class="signal-benchmark-val signal-benchmark-posts">{{ bl.post_count }}</span>
                        </div>
                        {% endfor %}
                        <div class="signal-benchmark-footnote">
                            Averages based on {{ selected_timeframe or '30d' }} window
                        </div>
                    </div>
                    <div class="signal-message-time">Competitor benchmarks</div>
                </div>
            </div>
            {% endif %}

            <!-- Consolidated Analysis Report -->
            {% if insights and insights.has_insights %}
            <div class="signal-message">
                <div class="signal-avatar">S</div>
                <div class="signal-message-content">
                    <div class="signal-message-bubble">
                        {{ insights.summary|md_bold }}
                    </div>

                    <!-- Single consolidated report card -->
                    {% if insights.report_sections %}
                    <div class="signal-report-card">
                        <div class="signal-report-header" onclick="toggleReport(this)">
                            <div class="signal-report-header-left">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--signal-cyan)" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                                <span>Competitive Intelligence Report</span>
                            </div>
                            <span class="signal-report-meta">{{ insights.outlier_count }} outliers analyzed</span>
                            <svg class="signal-report-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                        </div>

                        <div class="signal-report-body open">
                            {% for section in insights.report_sections %}
                            <div class="signal-report-section">
                                <div class="signal-report-section-title">
                                    {% if section.icon == 'formats' %}
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--signal-cyan)" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="2"/><line x1="8" y1="2" x2="8" y2="22"/></svg>
                                    {% elif section.icon == 'hooks' %}
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--signal-cyan)" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                                    {% elif section.icon == 'psychology' %}
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--signal-tag-purple)" stroke-width="2"><path d="M12 2a7 7 0 017 7c0 2.38-1.19 4.47-3 5.74V17a2 2 0 01-2 2h-4a2 2 0 01-2-2v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 017-7z"/><line x1="9" y1="21" x2="15" y2="21"/></svg>
                                    {% elif section.icon == 'drivers' %}
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--signal-cyan)" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>
                                    {% elif section.icon == 'playbook' %}
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--signal-success)" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                                    {% elif section.icon == 'ideas' %}
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--signal-cyan)" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                                    {% else %}
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--signal-cyan)" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                                    {% endif %}
                                    {{ section.title }}
                                </div>
                                <div class="signal-report-section-body">
                                    {% for line in section.lines %}
                                    <div class="signal-report-line">{{ line|md_bold }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Content Pattern Clusters (clickable filters) -->
                    {% if pattern_clusters %}
                    <div class="signal-report-clusters">
                        <div class="signal-report-clusters-label">Filter by pattern:</div>
                        <div class="signal-report-cluster-pills">
                            {% for cluster in pattern_clusters[:8] %}
                            <button class="signal-pill signal-cluster-pill" onclick="filterByCluster({{ cluster.pattern_name|tojson }})">
                                {{ cluster.pattern_name }} <span class="signal-cluster-count">{{ cluster.count }}</span>
                            </button>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Trend Radar (velocity-based sound/hashtag trends) -->
                    {% if trend_radar_trends %}
                    <div class="signal-report-section" style="margin-top: 16px;">
                        <div class="signal-report-section-title">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--signal-cyan)" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/><line x1="2" y1="12" x2="22" y2="12"/></svg>
                            Trend Radar
                        </div>
                        <div class="signal-report-section-body">
                            {% for trend in trend_radar_trends[:5] %}
                            <div class="signal-trend-item">
                                <span class="signal-trend-rank">#{{ trend.rank }}</span>
                                <span class="signal-trend-icon">{% if trend.item_type == 'sound' %}<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>{% else %}#{% endif %}</span>
                                <span class="signal-trend-name">{{ trend.item_name|truncate(30) }}</span>
                                <span class="signal-trend-velocity signal-trend-{{ trend.phase }}">{{ trend.velocity_label }}</span>
                            </div>
                            {% endfor %}
                            <div class="signal-trend-hint">Ask "what's trending?" for details + example posts</div>
                        </div>
                    </div>
                    {% endif %}

                    <div class="signal-message-time">{{ insights.outlier_count }} outliers analyzed</div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Chat Input -->
        <div class="signal-chat-input-area">
            <input
                type="text"
                class="signal-chat-input"
                id="chatInput"
                placeholder="Ask about your competitors..."
                autocomplete="off"
            >
        </div>
        <!-- Manual create category option (always visible) -->
        <div class="signal-chat-footer">
            <button type="button" class="signal-create-category-btn" onclick="openCreateModal()">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Create category
            </button>
            <button type="button" class="signal-create-category-btn signal-score-btn" onclick="openScorerModal()">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                </svg>
                Score content
            </button>
        </div>
    </div>

    <!-- ========== RIGHT PANEL: CONTENT ========== -->
    <div class="signal-content-panel">
        <!-- Content Header -->
        <div class="signal-content-header">
            <div class="signal-title-row">
                <h1 class="signal-content-title">Outliers Identified:</h1>
                <div style="display: flex; flex-direction: row; gap: 8px; align-items: center;">
                    <a href="{{ url_for('setup_page') }}" class="signal-settings-btn" title="Settings &amp; API keys">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/>
                        </svg>
                    </a>
                    <button class="signal-settings-btn" onclick="showGuideModal()" title="Quick Guide">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/>
                            <circle cx="12" cy="17" r="0.5" fill="currentColor"/>
                        </svg>
                    </button>
                    {% if auth_enabled and current_user %}
                    <div class="signal-user-menu" id="userMenu">
                        <button class="signal-user-avatar-btn" onclick="toggleUserMenu()" title="{{ current_user.email }}">
                            {% if current_user.picture %}
                            <img src="{{ current_user.picture }}" alt="" class="signal-user-avatar" referrerpolicy="no-referrer">
                            {% else %}
                            <span class="signal-user-avatar-fallback">{{ current_user.name[0] if current_user.name else 'U' }}</span>
                            {% endif %}
                        </button>
                        <div class="signal-user-dropdown" id="userDropdown" style="display:none;">
                            <div class="signal-user-dropdown-name">{{ current_user.name }}</div>
                            <div class="signal-user-dropdown-email">{{ current_user.email }}</div>
                            <hr class="signal-user-dropdown-divider">
                            <a href="{{ url_for('logout') }}" class="signal-user-dropdown-item" onclick="clearSplashOnLogout()">Sign out</a>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>


            <!-- First-Run Hints (shown once after first analysis) -->
            {% if outliers and not needs_setup %}
            <div class="signal-first-run-hints" id="firstRunHints" style="display:none;">
                <div class="signal-hint-card">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--signal-cyan)" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                    <span><strong>Multiplier</strong> shows how much more engagement a post got vs brand average</span>
                </div>
                <div class="signal-hint-card">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--signal-cyan)" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                    <span><strong>Click any card</strong> to see AI analysis — why it worked, what to replicate</span>
                </div>
                <div class="signal-hint-card">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--signal-cyan)" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
                    <span><strong>Ask the chatbot</strong> to filter, compare brands, or get content suggestions</span>
                </div>
                <button class="signal-hint-dismiss" onclick="dismissFirstRunHints()">Got it</button>
            </div>
            {% endif %}

            <!-- Filter Pills -->
            <div class="signal-filters">
                <!-- Competitive Sets Dropdown -->
                {% if saved_verticals %}
                <div class="signal-filter-group">
                    <span class="signal-filter-label">COMPETITIVE SET</span>
                    <div class="signal-filter-pills">
                        <div class="signal-vertical-dropdown-container">
                            <button class="signal-pill signal-vertical-dropdown-btn" onclick="toggleVerticalDropdown()">
                                <span class="signal-vertical-current">
                                    {% if vertical_name %}{{ vertical_name }}{% else %}Select a competitive set...{% endif %}
                                </span>
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="signal-dropdown-arrow">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>
                            <div class="signal-vertical-dropdown-menu" id="verticalDropdownMenu">
                                {% for vertical in saved_verticals %}
                                <div class="signal-vertical-option {% if vertical == vertical_name %}active{% endif %}">
                                    <span class="signal-vertical-name" onclick="loadVertical('{{ vertical }}')">{{ vertical }}</span>
                                    <button class="signal-vertical-delete" onclick="deleteVertical('{{ vertical }}', event)" title="Delete competitive set">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="3 6 5 6 21 6"></polyline>
                                            <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"></path>
                                            <line x1="10" y1="11" x2="10" y2="17"></line>
                                            <line x1="14" y1="11" x2="14" y2="17"></line>
                                        </svg>
                                    </button>
                                </div>
                                {% endfor %}
                                <!-- New Category: open create modal -->
                                <button type="button" class="signal-vertical-option signal-new-category-link" onclick="event.stopPropagation(); openCreateModal();">
                                    <span class="signal-vertical-name" style="color: var(--signal-cyan); font-size: 12px;">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="vertical-align: -1px; margin-right: 4px;">
                                            <line x1="12" y1="5" x2="12" y2="19"></line>
                                            <line x1="5" y1="12" x2="19" y2="12"></line>
                                        </svg>
                                        New Category
                                    </span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}


                <!-- Brands Filter (with manage link) -->
                {% if competitive_set %}
                <div class="signal-filter-group">
                    <span class="signal-filter-label">BRANDS
                        <a href="/verticals/{{ vertical_name }}/edit" class="signal-filter-manage" title="Manage brands">
                            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
                                <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                        </a>
                    </span>
                    <div class="signal-filter-pills">
                        <button class="signal-pill {% if not selected_competitor %}active{% endif %}"
                                onclick="applyFilter('competitor', '')">All ({{ competitive_set|length }})</button>
                        {% for brand in competitive_set %}
                            {% set handle = brand.instagram_handle or brand.tiktok_handle or '' %}
                            {% if handle %}
                            <button class="signal-pill brand-pill {% if selected_competitor == handle %}active{% endif %}"
                                    data-handle="{{ handle }}"
                                    data-vertical="{{ vertical_name }}"
                                    draggable="true"
                                    onclick="handleBrandClick(event, '{{ handle }}')">
                                <span class="brand-pill-name">@{{ handle }}</span>
                                <button class="brand-pill-delete" onclick="deleteBrandFromSet('{{ handle }}', '{{ vertical_name }}', event)" title="Remove brand">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                        <line x1="10" y1="11" x2="10" y2="17"></line>
                                        <line x1="14" y1="11" x2="14" y2="17"></line>
                                    </svg>
                                </button>
                            </button>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>

                <!-- Trash Zone for Drag & Drop -->
                <div id="trash-zone" class="trash-zone">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        <line x1="10" y1="11" x2="10" y2="17"></line>
                        <line x1="14" y1="11" x2="14" y2="17"></line>
                    </svg>
                    <span>Drop to remove</span>
                </div>
                {% endif %}

                <!-- Platform Filter -->
                <div class="signal-filter-group">
                    <span class="signal-filter-label">PLATFORM</span>
                    <div class="signal-filter-pills">
                        <button class="signal-pill {% if not selected_platform %}active{% endif %}"
                                onclick="applyFilter('platform', '')">All</button>
                        <button class="signal-pill {% if selected_platform == 'instagram' %}active{% endif %}"
                                onclick="applyFilter('platform', 'instagram')">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="2" y="2" width="20" height="20" rx="5"/>
                                <circle cx="12" cy="12" r="5"/>
                                <circle cx="17.5" cy="6.5" r="1.5" fill="currentColor"/>
                            </svg>
                            IG
                        </button>
                        <button class="signal-pill {% if selected_platform == 'tiktok' %}active{% endif %}"
                                onclick="applyFilter('platform', 'tiktok')">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19.59 6.69a4.83 4.83 0 01-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 01-2.88 2.5 2.89 2.89 0 01-2.89-2.89 2.89 2.89 0 012.89-2.89c.28 0 .54.04.79.1v-3.5a6.37 6.37 0 00-.79-.05A6.34 6.34 0 003.15 15.2a6.34 6.34 0 006.34 6.34 6.34 6.34 0 006.34-6.34V8.51a8.27 8.27 0 004.76 1.5v-3.4a4.85 4.85 0 01-1-.08z"/>
                            </svg>
                            TT
                        </button>
                        <button class="signal-pill {% if selected_platform == 'facebook' %}active{% endif %}"
                                onclick="applyFilter('platform', 'facebook')">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"/>
                            </svg>
                            FB
                        </button>
                    </div>
                </div>

                <!-- Timeframe Filter -->
                <div class="signal-filter-group">
                    <span class="signal-filter-label">TIMEFRAME</span>
                    <div class="signal-filter-pills">
                        <button class="signal-pill {% if selected_timeframe == '30d' or not selected_timeframe %}active{% endif %}"
                                onclick="applyFilter('timeframe', '30d')">30 Days</button>
                        <button class="signal-pill {% if selected_timeframe == '3mo' %}active{% endif %}{% if collection_timeframe == '30d' %} signal-pill-disabled{% endif %}"
                                onclick="{% if collection_timeframe != '30d' %}applyFilter('timeframe', '3mo'){% endif %}"
                                {% if collection_timeframe == '30d' %}title="Data collected for last 30 days only — re-run analysis with '3 months' to see this range" style="opacity:0.4;cursor:not-allowed;"{% endif %}>3 Months</button>
                    </div>
                </div>

                <!-- Sort Filter -->
                <div class="signal-filter-group">
                    <span class="signal-filter-label">SORT</span>
                    <div class="signal-filter-pills">
                        <button class="signal-pill {% if sort_by == 'score' %}active{% endif %}"
                                onclick="applyFilter('sort', 'score')">Score</button>
                        <button class="signal-pill {% if sort_by == 'saves' %}active{% endif %}"
                                onclick="applyFilter('sort', 'saves')">Saves</button>
                        <button class="signal-pill {% if sort_by == 'shares' %}active{% endif %}"
                                onclick="applyFilter('sort', 'shares')">Shares</button>
                        <button class="signal-pill {% if sort_by == 'date' %}active{% endif %}"
                                onclick="applyFilter('sort', 'date')">Recent</button>
                    </div>
                </div>

                <!-- Export -->
                {% if outliers %}
                <div class="signal-filter-group">
                    <span class="signal-filter-label">EXPORT</span>
                    <div class="signal-filter-pills">
                        <button class="signal-pill" onclick="exportCSV()">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="7 10 12 15 17 10"/>
                                <line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                            CSV
                        </button>
                    </div>
                </div>
                {% endif %}

                <!-- Reset Filters -->
                {% if selected_competitor or selected_platform or selected_timeframe == '3mo' or sort_by != 'score' %}
                <div class="signal-filter-group">
                    <span class="signal-filter-label">&nbsp;</span>
                    <div class="signal-filter-pills">
                        <button class="signal-pill signal-pill-reset" onclick="resetAllFilters()">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="1 4 1 10 7 10"/>
                                <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
                            </svg>
                            Reset
                        </button>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Content Grid -->
        <div class="signal-grid">
            {% if outliers %}
                {% for post in outliers %}
                <a href="{{ post.post_url }}" target="_blank" rel="noopener noreferrer" class="signal-card-link"
                   data-postid="{{ post.post_id }}"
                   data-pattern="{{ post.ai_analysis.content_pattern if post.ai_analysis and post.ai_analysis.content_pattern else '' }}">
                    <div class="signal-card" style="animation-delay: {{ loop.index0 * 0.05 }}s">
                        <!-- Card Media -->
                    <div class="signal-card-media">
                        <!-- Post Image/Video with smart fallback chain -->
                        {% set grad_name = ['purple', 'green', 'orange', 'pink', 'teal'][loop.index0 % 5] %}
                        {% if post.media_url %}
                            {% if post.media_type == 'video' and post.platform == 'tiktok' %}
                            <img src="/proxy-image?url={{ post.media_url|urlencode }}" alt="{{ post.competitor_name }} post" loading="lazy"
                                 data-platform="{{ post.platform }}" data-postid="{{ post.post_id }}" data-handle="{{ post.competitor_handle }}"
                                 onerror="handleImageError(this, '{{ grad_name }}')">
                            {% else %}
                            <img src="/proxy-image?url={{ post.media_url|urlencode }}" alt="{{ post.competitor_name }} post" loading="lazy"
                                 data-platform="{{ post.platform }}" data-postid="{{ post.post_id }}" data-handle="{{ post.competitor_handle }}"
                                 onerror="handleImageError(this, '{{ grad_name }}')">
                            {% endif %}
                        {% else %}
                            <img src="https://www.instagram.com/p/{{ post.post_id }}/media/?size=l" alt="{{ post.competitor_name }} post" loading="lazy"
                                 data-platform="{{ post.platform }}" data-postid="{{ post.post_id }}" data-handle="{{ post.competitor_handle }}"
                                 onerror="handleImageError(this, '{{ grad_name }}')"
                                 style="{% if post.platform == 'tiktok' %}display:none{% endif %}">
                            {% if post.platform == 'tiktok' %}
                            <div class="signal-gradient-{{ grad_name }}"></div>
                            {% endif %}
                        {% endif %}
                        <!-- Gradient fallback (hidden until needed) -->
                        <div class="signal-gradient-{{ grad_name }} signal-fallback-gradient" style="display:none;">
                            <div class="signal-fallback-info">
                                <span class="signal-fallback-handle">@{{ post.competitor_handle }}</span>
                                <span class="signal-fallback-type">{{ post.media_type|upper }}</span>
                                {% if post.likes %}
                                <span class="signal-fallback-stat">{{ "{:,}".format(post.likes) }} likes</span>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Platform Badge (Top-Left) -->
                        <div class="signal-platform-badge">
                            {% if post.platform == 'tiktok' %}
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19.59 6.69a4.83 4.83 0 01-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 01-2.88 2.5 2.89 2.89 0 01-2.89-2.89 2.89 2.89 0 012.89-2.89c.28 0 .54.04.79.1v-3.5a6.37 6.37 0 00-.79-.05A6.34 6.34 0 003.15 15.2a6.34 6.34 0 006.34 6.34 6.34 6.34 0 006.34-6.34V8.51a8.27 8.27 0 004.76 1.5v-3.4a4.85 4.85 0 01-1-.08z"/>
                            </svg>
                            {% elif post.platform == 'facebook' %}
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"/>
                            </svg>
                            {% else %}
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="2" y="2" width="20" height="20" rx="5"/>
                                <circle cx="12" cy="12" r="5"/>
                                <circle cx="17.5" cy="6.5" r="1.5" fill="currentColor"/>
                            </svg>
                            {% endif %}
                            @{{ post.competitor_handle }}
                        </div>

                        <!-- Multiplier Badge (Below Platform Badge) -->
                        {% if post.engagement_multiplier and post.engagement_multiplier >= 1.5 %}
                        <div class="signal-multiplier-badge">
                            {% if post.engagement_multiplier >= 5 %}
                            <span class="signal-multiplier-hot">{{ post.engagement_multiplier }}x</span>
                            {% elif post.engagement_multiplier >= 3 %}
                            <span class="signal-multiplier-high">{{ post.engagement_multiplier }}x</span>
                            {% else %}
                            <span class="signal-multiplier-med">{{ post.engagement_multiplier }}x</span>
                            {% endif %}
                            above baseline
                        </div>
                        {% endif %}

                        <!-- Date Badge -->
                        {% if post.posted_at %}
                        <div class="signal-date-badge">
                            {{ post.posted_at|timeago }}
                        </div>
                        {% endif %}

                        <!-- Category Tags (Top-Right) -->
                        {% if post.content_tags %}
                        <div class="signal-tags">
                            {% for tag in post.content_tags[:3] %}
                            <span class="signal-tag signal-tag-{{ loop.index0 % 5 }}">{{ tag }}</span>
                            {% endfor %}
                        </div>
                        {% endif %}

                        <!-- Score Ring (Bottom-Right) -->
                        <div class="signal-score-ring">
                            {% set pct = post.engagement_score_pct %}
                            {% set circ = 251.2 %}
                            {% set offset = circ - (circ * pct / 100) %}
                            {% if pct >= 90 %}{% set ring_class = "cyan" %}
                            {% elif pct >= 75 %}{% set ring_class = "green" %}
                            {% elif pct >= 50 %}{% set ring_class = "yellow" %}
                            {% else %}{% set ring_class = "dim" %}{% endif %}

                            <svg viewBox="0 0 88 88" class="signal-score-svg">
                                <circle class="signal-score-bg" cx="44" cy="44" r="40"/>
                                <circle class="signal-score-fg {{ ring_class }}" cx="44" cy="44" r="40"
                                        stroke-dasharray="{{ circ }}"
                                        stroke-dashoffset="{{ offset }}"/>
                            </svg>
                            <span class="signal-score-value">{{ pct }}</span>
                        </div>
                    </div>

                    <!-- Card Body -->
                    <div class="signal-card-body">
                        <!-- Per-Post Insight: Why It Worked -->
                        {% if insights and insights.post_insights and post.post_id in insights.post_insights %}
                        {% set pi = insights.post_insights[post.post_id] %}
                        {% if pi.why_it_worked %}
                        <div class="signal-card-insight">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="var(--signal-cyan)" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                            <span>{{ pi.why_it_worked[0][:120] }}{% if pi.why_it_worked[0]|length > 120 %}...{% endif %}</span>
                        </div>
                        {% endif %}
                        {% endif %}

                        <!-- Caption -->
                        {% if post.caption %}
                        <p class="signal-card-caption">"{{ post.caption[:150] }}{% if post.caption|length > 150 %}...{% endif %}"</p>
                        {% else %}
                        <p class="signal-card-caption" style="opacity: 0.5;">(No caption)</p>
                        {% endif %}

                        <!-- Stats -->
                        <div class="signal-card-stats">
                            <div class="signal-stat">
                                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/>
                                </svg>
                                {{ "{:,}".format(post.likes) if post.likes else '0' }}
                            </div>
                            <div class="signal-stat">
                                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>
                                </svg>
                                {{ "{:,}".format(post.comments) if post.comments else '0' }}
                            </div>
                            {% if post.saves %}
                            <div class="signal-stat">
                                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M19 21l-7-5-7 5V5a2 2 0 012-2h10a2 2 0 012 2z"/>
                                </svg>
                                {{ "{:,}".format(post.saves) }}
                            </div>
                            {% endif %}
                            {% if post.shares %}
                            <div class="signal-stat">
                                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8"/>
                                    <polyline points="16 6 12 2 8 6"/>
                                    <line x1="12" y1="2" x2="12" y2="15"/>
                                </svg>
                                {{ "{:,}".format(post.shares) }}
                            </div>
                            {% endif %}
                        </div>

                        <!-- Expandable AI Analysis Section -->
                        {% if post.ai_analysis %}
                        {% set ai = post.ai_analysis %}
                        <div class="signal-expand-trigger" onclick="event.preventDefault(); event.stopPropagation(); toggleInsight(this)">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                            <span>Deep Insight</span>
                        </div>
                        <div class="signal-expand-panel" onclick="event.preventDefault(); event.stopPropagation();">
                            {% if ai.one_line_summary %}
                            <div class="signal-insight-summary">{{ ai.one_line_summary }}</div>
                            {% endif %}

                            {% if ai.hook_breakdown %}
                            <div class="signal-insight-section">
                                <div class="signal-insight-label">Hook</div>
                                <div class="signal-insight-text">{{ ai.hook_breakdown }}</div>
                            </div>
                            {% endif %}

                            {% if ai.why_it_worked %}
                            <div class="signal-insight-section">
                                <div class="signal-insight-label">Why it worked</div>
                                <div class="signal-insight-text">{{ ai.why_it_worked }}</div>
                            </div>
                            {% endif %}

                            {% if ai.emotional_trigger %}
                            <div class="signal-insight-section">
                                <div class="signal-insight-label">Emotional trigger</div>
                                <div class="signal-insight-text">{{ ai.emotional_trigger }}</div>
                            </div>
                            {% endif %}

                            {% if ai.content_pattern %}
                            <div class="signal-insight-section">
                                <div class="signal-insight-label">Pattern</div>
                                <div class="signal-insight-tag">{{ ai.content_pattern }}</div>
                            </div>
                            {% endif %}

                            {% if ai.visual_strategy %}
                            <div class="signal-insight-section">
                                <div class="signal-insight-label">Visual strategy</div>
                                <div class="signal-insight-text">{{ ai.visual_strategy }}</div>
                            </div>
                            {% endif %}

                            {% if ai.brand_creative_brief %}
                            {% set brief = ai.brand_creative_brief %}
                            <div class="signal-brief-divider"></div>
                            <div class="signal-brief-header">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="var(--signal-cyan)" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                                Your Creative Brief
                            </div>

                            {% if brief.one_line_summary %}
                            <div class="signal-insight-section">
                                <div class="signal-insight-label">Concept</div>
                                <div class="signal-insight-text">{{ brief.one_line_summary }}</div>
                            </div>
                            {% endif %}

                            {% if brief.hook_line %}
                            <div class="signal-insight-section">
                                <div class="signal-insight-label">Hook line</div>
                                <div class="signal-insight-quote">"{{ brief.hook_line }}"</div>
                            </div>
                            {% endif %}

                            {% if brief.suggested_caption %}
                            <div class="signal-insight-section">
                                <div class="signal-insight-label">Suggested caption</div>
                                <div class="signal-insight-caption">{{ brief.suggested_caption }}</div>
                            </div>
                            {% endif %}

                            {% if brief.visual_concept %}
                            <div class="signal-insight-section">
                                <div class="signal-insight-label">Visual direction</div>
                                <div class="signal-insight-text">{{ brief.visual_concept }}</div>
                            </div>
                            {% endif %}

                            {% if brief.what_to_replicate %}
                            <div class="signal-insight-section">
                                <div class="signal-insight-label">Replicate</div>
                                <div class="signal-insight-text">{{ brief.what_to_replicate }}</div>
                            </div>
                            {% endif %}

                            {% if brief.what_to_avoid %}
                            <div class="signal-insight-section">
                                <div class="signal-insight-label">Avoid</div>
                                <div class="signal-insight-text">{{ brief.what_to_avoid }}</div>
                            </div>
                            {% endif %}

                            {% if brief.format %}
                            <div class="signal-brief-meta">
                                <span class="signal-brief-tag">{{ brief.format }}</span>
                                {% if brief.brand_fit_score %}
                                <span class="signal-brief-score">Fit: {{ brief.brand_fit_score }}/10</span>
                                {% endif %}
                            </div>
                            {% endif %}
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    </div>
                </a>
                {% endfor %}
            {% elif not saved_verticals %}
                <!-- No categories yet: prompt to create first competitive set -->
                <div class="signal-empty">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                    </svg>
                    <h3>Create your first competitive set</h3>
                    <p>Add a category (e.g. Streetwear, Beauty) and the brands you want to track. Then run an analysis to find outlier posts.</p>
                    <button type="button" class="signal-empty-cta" onclick="openCreateModal()">Create category</button>
                </div>
            {% else %}
                <!-- Empty State: has categories but no outliers yet -->
                <div class="signal-empty">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="M21 21l-4.35-4.35"></path>
                    </svg>
                    <h3>No outlier posts yet</h3>
                    <p>Run an analysis to find viral content from your competitors.</p>
                    <div class="signal-empty-steps">
                        <div class="signal-empty-step">
                            <span class="signal-empty-step-num">1</span>
                            <span>Select a competitive set from the dropdown above</span>
                        </div>
                        <div class="signal-empty-step">
                            <span class="signal-empty-step-num">2</span>
                            <span>Type <code>"analyze"</code> in the chat — takes ~2 minutes</span>
                        </div>
                        <div class="signal-empty-step">
                            <span class="signal-empty-step-num">3</span>
                            <span>Outlier posts will appear here, ranked by score</span>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Quick Guide Modal -->
    <div class="signal-modal-overlay" id="guideModal" role="dialog" aria-modal="true" aria-label="Quick Guide">
        <div class="signal-modal" style="max-width: 520px;">
            <div class="signal-modal-header">
                <h3 class="signal-modal-title">Quick Guide</h3>
                <button type="button" class="signal-modal-close" onclick="closeGuideModal()" aria-label="Close">&times;</button>
            </div>
            <div style="padding: 20px; max-height: 70vh; overflow-y: auto;">
                <div class="signal-guide-section">
                    <div class="signal-guide-heading">Getting Started</div>
                    <p class="signal-guide-desc">Create a competitive set, add brand handles, and run your first analysis.</p>
                    <div class="signal-guide-examples">
                        <code>"Create a category called Streetwear"</code>
                        <code>"Add @nike @kith @stussy to Streetwear"</code>
                        <code>"Analyze Streetwear"</code>
                    </div>
                </div>
                <div class="signal-guide-section">
                    <div class="signal-guide-heading">Filter & Browse</div>
                    <p class="signal-guide-desc">Filter outlier posts by platform, brand, or timeframe without re-running analysis.</p>
                    <div class="signal-guide-examples">
                        <code>"Show me TikTok posts"</code>
                        <code>"Filter to @nike"</code>
                        <code>"Show me posts from the last 3 months"</code>
                    </div>
                </div>
                <div class="signal-guide-section">
                    <div class="signal-guide-heading">Score Your Content</div>
                    <p class="signal-guide-desc">Test a caption or concept against learned patterns from competitor outliers. Shows format fit, hook strength, pattern alignment, voice match, and competitive gap fill. No API cost.</p>
                    <div class="signal-guide-examples">
                        <code>"Score this: Just dropped our latest collection. Link in bio."</code>
                        <code>"How would this caption perform as a reel?"</code>
                        <code>"Rate this hook: You've been styling this wrong"</code>
                    </div>
                </div>
                <div class="signal-guide-section">
                    <div class="signal-guide-heading">Optimize</div>
                    <p class="signal-guide-desc">After scoring, ask for AI-powered improvements targeting your weakest areas. Uses GPT-4o-mini.</p>
                    <div class="signal-guide-examples">
                        <code>"Optimize it"</code>
                        <code>"Improve the hook"</code>
                        <code>"Make it better for TikTok"</code>
                    </div>
                </div>
                <div class="signal-guide-section">
                    <div class="signal-guide-heading">Trend Radar</div>
                    <p class="signal-guide-desc">See which sounds, hashtags, and content patterns are gaining momentum before they peak. Velocity-based -- surfaces fast-growing signals, not just popular ones. Includes links to example posts.</p>
                    <div class="signal-guide-examples">
                        <code>"What's trending?"</code>
                        <code>"What sounds are hot right now?"</code>
                        <code>"Show me rising hashtags"</code>
                        <code>"What should I post about this week?"</code>
                    </div>
                </div>
                <div class="signal-guide-section">
                    <div class="signal-guide-heading">Manage Brands</div>
                    <p class="signal-guide-desc">Add, remove, or list brands and categories at any time.</p>
                    <div class="signal-guide-examples">
                        <code>"Show categories"</code>
                        <code>"Remove @nike from Streetwear"</code>
                        <code>"Add @zara to Fast Fashion"</code>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Content Scorer Modal -->
    <div class="signal-modal-overlay" id="scorerModal" role="dialog" aria-modal="true" aria-label="Score Content">
        <div class="signal-modal" style="max-width: 560px;">
            <div class="signal-modal-header">
                <h3 class="signal-modal-title">Score Your Content</h3>
                <button type="button" class="signal-modal-close" onclick="closeScorerModal()" aria-label="Close">&times;</button>
            </div>
            <div style="padding: 20px;">
                <!-- Scorer Form -->
                <div id="scorerForm">
                    <div class="signal-scorer-row">
                        <div class="signal-form-group" style="flex:1">
                            <label class="signal-form-label">Platform</label>
                            <select id="scorerPlatform" class="signal-form-input">
                                <option value="instagram">Instagram</option>
                                <option value="tiktok">TikTok</option>
                                <option value="facebook">Facebook</option>
                            </select>
                        </div>
                        <div class="signal-form-group" style="flex:1">
                            <label class="signal-form-label">Format</label>
                            <select id="scorerFormat" class="signal-form-input">
                                <option value="reel">Reel</option>
                                <option value="carousel">Carousel</option>
                                <option value="static">Static</option>
                                <option value="story">Story</option>
                            </select>
                        </div>
                    </div>
                    <div class="signal-form-group">
                        <label class="signal-form-label">Hook line <span class="signal-form-optional">(optional)</span></label>
                        <input type="text" id="scorerHook" class="signal-form-input" placeholder="e.g. You've been styling this wrong">
                    </div>
                    <div class="signal-form-group">
                        <label class="signal-form-label">Caption</label>
                        <textarea id="scorerCaption" class="signal-form-textarea" rows="4" placeholder="Enter your caption or concept text..."></textarea>
                    </div>
                    <button type="button" class="signal-btn-primary" style="width:100%" onclick="runScore()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                        </svg>
                        Score This Concept
                    </button>
                </div>

                <!-- Score Results (hidden initially) -->
                <div id="scorerResults" style="display:none;">
                    <div class="signal-scorer-result-header">
                        <div class="signal-scorer-score-ring">
                            <svg viewBox="0 0 88 88" class="signal-score-svg">
                                <circle class="signal-score-bg" cx="44" cy="44" r="40"/>
                                <circle id="scorerScoreRing" class="signal-score-fg cyan" cx="44" cy="44" r="40" stroke-dasharray="251.2" stroke-dashoffset="251.2"/>
                            </svg>
                            <span class="signal-score-value" id="scorerScoreValue">0</span>
                        </div>
                        <div>
                            <div class="signal-scorer-score-label">Overall Score</div>
                            <div class="signal-scorer-predicted" id="scorerPredicted"></div>
                        </div>
                        <button type="button" class="signal-btn-primary signal-optimize-btn" id="scorerOptimizeBtn" onclick="runOptimize()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 2a7 7 0 017 7c0 2.38-1.19 4.47-3 5.74V17a2 2 0 01-2 2h-4a2 2 0 01-2-2v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 017-7z"/>
                                <line x1="9" y1="21" x2="15" y2="21"/>
                            </svg>
                            Optimize
                        </button>
                    </div>

                    <!-- Breakdown Bars -->
                    <div class="signal-scorer-breakdown" id="scorerBreakdown"></div>

                    <!-- Suggestions -->
                    <div class="signal-scorer-suggestions" id="scorerSuggestions"></div>

                    <!-- Optimized Results (shown after optimize) -->
                    <div id="scorerOptimized" style="display:none;">
                        <div class="signal-scorer-divider"></div>
                        <div class="signal-scorer-optimized-header">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--signal-success)" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                            AI-Improved Version
                        </div>
                        <div class="signal-scorer-improved-caption" id="scorerImprovedCaption"></div>
                        <div class="signal-scorer-improved-hook" id="scorerImprovedHook"></div>
                        <div class="signal-scorer-improvements" id="scorerImprovements"></div>
                        <div class="signal-scorer-new-score" id="scorerNewScore"></div>
                    </div>

                    <button type="button" class="signal-btn-outline" style="width:100%;margin-top:16px" onclick="resetScorer()">Score Another</button>
                </div>

                <!-- Loading State -->
                <div id="scorerLoading" style="display:none;" class="signal-scorer-loading">
                    <div class="analysis-spinner"></div>
                    <p id="scorerLoadingMsg">Scoring your concept...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Category modal (all create flows stay on /signal) -->
    <div class="signal-modal-overlay" id="createCategoryModal" role="dialog" aria-modal="true" aria-label="Create category">
        <div class="signal-modal">
            <div class="signal-modal-header">
                <h3 class="signal-modal-title">Create category</h3>
                <button type="button" class="signal-modal-close" onclick="closeCreateModal()" aria-label="Close">&times;</button>
            </div>
            <form method="POST" action="{{ url_for('create_vertical') }}" class="signal-modal-form">
                <div class="signal-form-group">
                    <label class="signal-form-label">Category name</label>
                    <input type="text" name="vertical_name" class="signal-form-input" required
                           placeholder="e.g. Streetwear, Beauty, Gaming">
                </div>
                <div class="signal-form-group">
                    <label class="signal-form-label">Description <span class="signal-form-optional">(optional)</span></label>
                    <input type="text" name="description" class="signal-form-input"
                           placeholder="e.g. Premium streetwear brands">
                </div>
                <div class="signal-form-group">
                    <label class="signal-form-label">Brand handles</label>
                    <textarea name="bulk_handles" class="signal-form-textarea" rows="5"
                              placeholder="@supremenewyork&#10;@stussy&#10;@palaceskateboards&#10;One per line. Add @handle | tiktok for TikTok only."></textarea>
                </div>
                <div class="signal-modal-actions">
                    <button type="button" class="signal-btn-outline" onclick="closeCreateModal()">Cancel</button>
                    <button type="submit" class="signal-btn-primary">Create &amp; start tracking</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Active vertical name — used by redirects to preserve context across page loads
// Uses 'let' so chat responses can update it when user creates/switches verticals
let currentVertical = {{ vertical_name|tojson if vertical_name else 'null' }};

// ── BYOK: Hide setup prompt if API keys exist in localStorage ──
(function() {
    const hasOpenAI = localStorage.getItem('scout_openai_key');
    const hasApify = localStorage.getItem('scout_apify_token');
    if (hasOpenAI && hasApify) {
        const setupPrompt = document.getElementById('setupPrompt');
        const byokWelcome = document.getElementById('byokWelcome');
        if (setupPrompt) setupPrompt.style.display = 'none';
        if (byokWelcome) byokWelcome.style.display = 'block';
    }
})();

// User menu toggle
function toggleUserMenu() {
    const dd = document.getElementById('userDropdown');
    if (dd) dd.style.display = dd.style.display === 'none' ? 'block' : 'none';
}
// Close user menu when clicking outside
document.addEventListener('click', function(e) {
    const menu = document.getElementById('userMenu');
    const dd = document.getElementById('userDropdown');
    if (menu && dd && !menu.contains(e.target)) {
        dd.style.display = 'none';
    }
});

// Quick Guide modal
function showGuideModal() {
    document.getElementById('guideModal').classList.add('open');
    document.body.style.overflow = 'hidden';
}
function closeGuideModal() {
    document.getElementById('guideModal').classList.remove('open');
    document.body.style.overflow = '';
}
document.getElementById('guideModal').addEventListener('click', function(e) {
    if (e.target === this) closeGuideModal();
});

// Reset all filters to defaults
function resetAllFilters() {
    const url = new URL(window.location.href);
    url.searchParams.delete('competitor');
    url.searchParams.delete('platform');
    url.searchParams.delete('sort');
    url.searchParams.set('timeframe', '30d');
    history.pushState(null, '', url.toString());
    // Update active pills
    document.querySelectorAll('.signal-pill.active').forEach(p => p.classList.remove('active'));
    // Re-activate defaults
    document.querySelectorAll('.signal-pill').forEach(p => {
        const txt = p.textContent.trim();
        if (txt.startsWith('All') || txt === '30 Days' || txt === 'Score') p.classList.add('active');
    });
    showSkeletonState();
    fetchFilteredOutliers();
}

// Template card: send chat message to create category + add brands
function useTemplate(name, handles) {
    // Send directly via chat — ScoutAgent (GPT) will understand the intent
    // and create the category + add all brands in one go.
    const msg = 'Create a ' + name + ' category and add ' + handles;
    sendChatMessage(msg);
}


// First-run hints: show once after first analysis
(function checkFirstRun() {
    const hints = document.getElementById('firstRunHints');
    if (!hints) return;
    const key = 'scout_first_run_dismissed';
    if (!localStorage.getItem(key)) {
        hints.style.display = '';
    }
})();
function dismissFirstRunHints() {
    const hints = document.getElementById('firstRunHints');
    if (hints) hints.style.display = 'none';
    localStorage.setItem('scout_first_run_dismissed', '1');
}

// Create category modal
function openCreateModal() {
    document.querySelectorAll('.signal-vertical-dropdown-menu').forEach(m => m.classList.remove('open'));
    document.getElementById('createCategoryModal').classList.add('open');
    document.body.style.overflow = 'hidden';
}
function closeCreateModal() {
    document.getElementById('createCategoryModal').classList.remove('open');
    document.body.style.overflow = '';
}
document.getElementById('createCategoryModal').addEventListener('click', function(e) {
    if (e.target === this) closeCreateModal();
});
// Open modal when arriving with ?create=1 (e.g. from archived /verticals/create or after setup)
// DISABLED: Auto-popup was intrusive when returning from settings
// if (new URLSearchParams(window.location.search).get('create') === '1') {
//     openCreateModal();
//     history.replaceState({}, '', window.location.pathname + (window.location.hash || ''));
// }

// Image fallback chain: proxy -> Instagram embed thumbnail -> gradient
function handleImageError(img, gradientName) {
    const platform = img.dataset.platform;
    const postId = img.dataset.postid;
    const retryAttempt = parseInt(img.dataset.retry || '0');

    if (retryAttempt === 0 && platform === 'instagram' && postId) {
        // Try Instagram's public embed media endpoint
        img.dataset.retry = '1';
        img.src = `https://www.instagram.com/p/${postId}/media/?size=l`;
        return;
    }

    // All retries exhausted — show gradient fallback
    img.style.display = 'none';
    const fallback = img.closest('.signal-card-media').querySelector('.signal-fallback-gradient');
    if (fallback) {
        fallback.style.display = 'flex';
    }
}

// Expand/collapse insight panel on post cards
function toggleInsight(trigger) {
    const panel = trigger.nextElementSibling;
    const isOpen = trigger.classList.contains('open');
    // Close any other open panels
    document.querySelectorAll('.signal-expand-trigger.open').forEach(t => {
        if (t !== trigger) {
            t.classList.remove('open');
            t.nextElementSibling.classList.remove('open');
        }
    });
    trigger.classList.toggle('open', !isOpen);
    panel.classList.toggle('open', !isOpen);
}

// Toggle consolidated report
function toggleReport(header) {
    const body = header.nextElementSibling;
    const isOpen = body.classList.contains('open');
    header.classList.toggle('collapsed', !isOpen);
    body.classList.toggle('open', !isOpen);
}

// Toggle benchmarks panel
function toggleBenchmarks(trigger) {
    const panel = trigger.nextElementSibling;
    const isOpen = trigger.classList.contains('open');
    trigger.classList.toggle('open', !isOpen);
    panel.classList.toggle('open', !isOpen);
}

// Filter post grid by content pattern cluster
let activeClusterFilter = null;
function filterByCluster(patternName) {
    const cards = document.querySelectorAll('.signal-card-link');
    const clusterPills = document.querySelectorAll('.signal-cluster-pill');

    // Toggle off if clicking the same cluster
    if (activeClusterFilter === patternName) {
        activeClusterFilter = null;
        cards.forEach(card => { card.style.display = ''; });
        clusterPills.forEach(c => c.classList.remove('signal-cluster-active'));
        return;
    }

    activeClusterFilter = patternName;

    // Highlight active cluster pill
    clusterPills.forEach(pill => {
        // The pill text includes the count span, so check textContent of first text node
        const pillText = pill.childNodes[0].textContent.trim();
        if (pillText === patternName) {
            pill.classList.add('signal-cluster-active');
        } else {
            pill.classList.remove('signal-cluster-active');
        }
    });

    // Show/hide post cards
    cards.forEach(card => {
        const cardPattern = card.getAttribute('data-pattern') || '';
        if (cardPattern === patternName) {
            card.style.display = '';
        } else {
            card.style.display = 'none';
        }
    });
}

// ── AJAX Filter handling (progressive UX — no full page reload) ──
function applyFilter(key, value) {
    const url = new URL(window.location.href);
    url.searchParams.set(key, value);

    // Update URL without reload (for bookmarkability)
    history.pushState(null, '', url.toString());

    // Update active pill styling
    updateActivePills(key, value);

    // Show skeleton loading state
    showSkeletonState();

    // Fetch filtered data via AJAX
    fetchFilteredOutliers();

    // Sync filter state to chatbot context (fire-and-forget)
    syncFilterToChat(key, value);
}

function updateActivePills(key, value) {
    // Map filter keys to their pill groups
    const groupLabels = {
        'platform': 'PLATFORM',
        'timeframe': 'TIMEFRAME',
        'sort': 'SORT',
    };
    const label = groupLabels[key];
    if (!label) return;

    document.querySelectorAll('.signal-filter-group').forEach(group => {
        const groupLabel = group.querySelector('.signal-filter-label');
        if (groupLabel && groupLabel.textContent.trim() === label) {
            group.querySelectorAll('.signal-pill').forEach(pill => {
                pill.classList.remove('active');
            });
            // Find the pill that matches the value
            group.querySelectorAll('.signal-pill').forEach(pill => {
                const onclick = pill.getAttribute('onclick') || '';
                if (onclick.includes(`'${value}'`)) {
                    pill.classList.add('active');
                }
                // Handle "All" button (empty value)
                if (value === '' && onclick.includes("''")) {
                    pill.classList.add('active');
                }
            });
        }
    });
}

function showSkeletonState() {
    const grid = document.querySelector('.signal-grid');
    if (!grid) return;
    let html = '';
    for (let i = 0; i < 6; i++) {
        html += `
            <div class="signal-card-link skeleton-card" style="animation-delay: ${i * 0.1}s">
                <div class="signal-card">
                    <div class="signal-card-media skeleton-media"></div>
                    <div class="signal-card-body">
                        <div class="skeleton-line" style="width: 80%"></div>
                        <div class="skeleton-line" style="width: 60%"></div>
                        <div class="skeleton-line" style="width: 40%"></div>
                    </div>
                </div>
            </div>`;
    }
    grid.innerHTML = html;
}

async function fetchFilteredOutliers() {
    const params = new URLSearchParams(window.location.search);
    try {
        const response = await fetch('/api/outliers?' + params.toString());
        const data = await response.json();

        // Update the outlier count in header
        const countEl = document.querySelector('.signal-chat-subtitle');
        if (countEl) {
            countEl.textContent = `Outliers Identified: ${data.count} posts`;
        }

        // Re-render the grid (full page reload for now — the Jinja2 cards are complex)
        // For MVP, reload if data changed since skeleton was shown
        window.location.reload();
    } catch (error) {
        console.error('Failed to fetch outliers:', error);
        // Fallback: reload page
        window.location.reload();
    }
}

function syncFilterToChat(key, value) {
    fetch('/chat/context', {
        method: 'POST',
        headers: getBYOKHeaders(),
        body: JSON.stringify({ filter_key: key, filter_value: value })
    }).catch(() => {}); // Fire and forget
}

function exportCSV() {
    const params = new URLSearchParams(window.location.search);
    window.open('/api/export/csv?' + params.toString(), '_blank');
}

// Pattern filtering
function filterByPattern(patternName) {
    applyFilter('tag', patternName);
}

// ── Content Scorer Modal ──
let lastScoreData = null;
let lastScoreId = null;
let lastScoredConcept = null;

function openScorerModal() {
    document.getElementById('scorerModal').classList.add('open');
    document.body.style.overflow = 'hidden';
}
function closeScorerModal() {
    document.getElementById('scorerModal').classList.remove('open');
    document.body.style.overflow = '';
}
document.getElementById('scorerModal').addEventListener('click', function(e) {
    if (e.target === this) closeScorerModal();
});

function resetScorer() {
    document.getElementById('scorerForm').style.display = '';
    document.getElementById('scorerResults').style.display = 'none';
    document.getElementById('scorerLoading').style.display = 'none';
    document.getElementById('scorerOptimized').style.display = 'none';
    document.getElementById('scorerCaption').value = '';
    document.getElementById('scorerHook').value = '';
    lastScoreData = null;
    lastScoreId = null;
    lastScoredConcept = null;
}

async function runScore() {
    const caption = document.getElementById('scorerCaption').value.trim();
    if (!caption) { alert('Please enter a caption.'); return; }

    const concept = {
        caption: caption,
        hook_line: document.getElementById('scorerHook').value.trim(),
        format: document.getElementById('scorerFormat').value,
        platform: document.getElementById('scorerPlatform').value,
    };

    document.getElementById('scorerForm').style.display = 'none';
    document.getElementById('scorerResults').style.display = 'none';
    document.getElementById('scorerLoading').style.display = '';
    document.getElementById('scorerLoadingMsg').textContent = 'Scoring your concept...';

    try {
        const resp = await fetch('/api/score-concept', {
            method: 'POST',
            headers: getBYOKHeaders(),
            body: JSON.stringify(concept),
        });
        const data = await resp.json();
        if (data.error) throw new Error(data.error);

        lastScoreData = data;
        lastScoreId = data.score_id;
        lastScoredConcept = concept;
        renderScoreResults(data);

        document.getElementById('scorerLoading').style.display = 'none';
        document.getElementById('scorerResults').style.display = '';
    } catch (err) {
        document.getElementById('scorerLoading').style.display = 'none';
        document.getElementById('scorerForm').style.display = '';
        alert('Scoring failed: ' + err.message);
    }
}

function renderScoreResults(data) {
    const score = Math.round(data.overall_score || 0);
    const circ = 251.2;
    const offset = circ - (circ * score / 100);

    // Score ring
    const ring = document.getElementById('scorerScoreRing');
    ring.style.strokeDashoffset = offset;
    ring.className = 'signal-score-fg ' + (score >= 80 ? 'cyan' : score >= 60 ? 'green' : score >= 40 ? 'yellow' : 'dim');
    document.getElementById('scorerScoreValue').textContent = score;

    // Predicted engagement
    const pred = data.predicted_engagement_range;
    if (pred && pred.mid) {
        document.getElementById('scorerPredicted').textContent =
            'Predicted: ' + Math.round(pred.low).toLocaleString() + ' - ' + Math.round(pred.high).toLocaleString() + ' likes';
    } else {
        document.getElementById('scorerPredicted').textContent = '';
    }

    // Breakdown bars
    const breakdown = data.breakdown || {};
    const dims = ['format_fit', 'hook_strength', 'pattern_alignment', 'voice_match', 'competitive_gap_fill'];
    const labels = {'format_fit': 'Format Fit', 'hook_strength': 'Hook Strength', 'pattern_alignment': 'Pattern Match', 'voice_match': 'Voice Match', 'competitive_gap_fill': 'Gap Fill'};
    let barsHtml = '';
    dims.forEach(dim => {
        const d = breakdown[dim] || {};
        const s = d.score || 0;
        const pct = (s / 20) * 100;
        const color = pct >= 80 ? 'var(--signal-cyan)' : pct >= 60 ? 'var(--signal-success)' : pct >= 40 ? 'var(--signal-warning)' : 'var(--signal-error)';
        barsHtml += `<div class="signal-scorer-bar-row">
            <span class="signal-scorer-bar-label">${labels[dim] || dim}</span>
            <div class="signal-scorer-bar-track"><div class="signal-scorer-bar-fill" style="width:${pct}%;background:${color}"></div></div>
            <span class="signal-scorer-bar-value">${s}/20</span>
        </div>`;
    });
    document.getElementById('scorerBreakdown').innerHTML = barsHtml;

    // Suggestions
    const suggs = data.suggestions || [];
    let suggsHtml = '';
    suggs.forEach(s => {
        suggsHtml += `<div class="signal-scorer-suggestion">${s}</div>`;
    });
    document.getElementById('scorerSuggestions').innerHTML = suggsHtml;
}

async function runOptimize() {
    if (!lastScoredConcept) return;

    document.getElementById('scorerOptimizeBtn').disabled = true;
    document.getElementById('scorerOptimizeBtn').textContent = 'Optimizing...';

    try {
        const resp = await fetch('/api/optimize-concept', {
            method: 'POST',
            headers: getBYOKHeaders(),
            body: JSON.stringify({
                caption: lastScoredConcept.caption,
                hook_line: lastScoredConcept.hook_line,
                format: lastScoredConcept.format,
                platform: lastScoredConcept.platform,
                score_data: lastScoreData,
                score_id: lastScoreId,
            }),
        });
        const data = await resp.json();
        if (data.error) throw new Error(data.error);

        const opt = data.optimized || {};
        const newScore = data.new_score || {};

        // Show improved caption
        document.getElementById('scorerImprovedCaption').textContent = opt.improved_caption || '';
        document.getElementById('scorerImprovedHook').textContent = opt.improved_hook ? 'Hook: "' + opt.improved_hook + '"' : '';

        // Improvements list
        const improvements = opt.improvements || [];
        let impHtml = '';
        improvements.forEach(imp => {
            impHtml += `<div class="signal-scorer-improvement"><strong>${imp.area}:</strong> ${imp.suggestion}</div>`;
        });
        document.getElementById('scorerImprovements').innerHTML = impHtml;

        // New score comparison
        const oldScore = Math.round(lastScoreData.overall_score || 0);
        const newScoreVal = Math.round(newScore.overall_score || 0);
        const diff = newScoreVal - oldScore;
        const diffStr = diff > 0 ? '+' + diff : '' + diff;
        document.getElementById('scorerNewScore').innerHTML =
            `<span class="signal-scorer-score-compare">Score: ${oldScore} → <strong>${newScoreVal}</strong> (${diffStr})</span>`;

        // Update state for further optimization
        lastScoreData = newScore;
        lastScoreId = data.new_score_id;
        lastScoredConcept = {
            caption: opt.improved_caption,
            hook_line: opt.improved_hook,
            format: opt.format_recommendation || lastScoredConcept.format,
            platform: lastScoredConcept.platform,
        };

        document.getElementById('scorerOptimized').style.display = '';
        document.getElementById('scorerOptimizeBtn').disabled = false;
        document.getElementById('scorerOptimizeBtn').textContent = 'Optimize Again';

        // Re-render main score with new data
        renderScoreResults(newScore);

    } catch (err) {
        document.getElementById('scorerOptimizeBtn').disabled = false;
        document.getElementById('scorerOptimizeBtn').innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a7 7 0 017 7c0 2.38-1.19 4.47-3 5.74V17a2 2 0 01-2 2h-4a2 2 0 01-2-2v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 017-7z"/><line x1="9" y1="21" x2="15" y2="21"/></svg> Optimize';
        alert('Optimization failed: ' + err.message);
    }
}

// ── Score Card in Chat (for chatbot-triggered scoring) ──
function addScoreCard(data) {
    const messagesDiv = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'signal-message';

    const avatar = document.createElement('div');
    avatar.className = 'signal-avatar';
    avatar.textContent = 'S';

    const content = document.createElement('div');
    content.className = 'signal-message-content';

    const score = Math.round(data.overall_score || 0);
    const breakdown = data.breakdown || {};
    const dims = ['format_fit', 'hook_strength', 'pattern_alignment', 'voice_match', 'competitive_gap_fill'];
    const labels = {'format_fit': 'Format Fit', 'hook_strength': 'Hook Strength', 'pattern_alignment': 'Pattern Match', 'voice_match': 'Voice Match', 'competitive_gap_fill': 'Gap Fill'};

    let barsHtml = '';
    dims.forEach(dim => {
        const d = breakdown[dim] || {};
        const s = d.score || 0;
        const pct = (s / 20) * 100;
        const color = pct >= 80 ? 'var(--signal-cyan)' : pct >= 60 ? 'var(--signal-success)' : pct >= 40 ? 'var(--signal-warning)' : 'var(--signal-error)';
        barsHtml += `<div class="signal-scorer-bar-row"><span class="signal-scorer-bar-label">${labels[dim] || dim}</span><div class="signal-scorer-bar-track"><div class="signal-scorer-bar-fill" style="width:${pct}%;background:${color}"></div></div><span class="signal-scorer-bar-value">${s}/20</span></div>`;
    });

    const card = document.createElement('div');
    card.className = 'signal-insight-card';
    card.style.marginTop = '12px';
    card.innerHTML = `
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
            <div style="font-size:28px;font-weight:700;color:${score >= 80 ? 'var(--signal-cyan)' : score >= 60 ? 'var(--signal-success)' : score >= 40 ? 'var(--signal-warning)' : 'var(--signal-error)'}">${score}/100</div>
            <div style="font-size:12px;color:var(--signal-text-dim)">Content Score</div>
        </div>
        ${barsHtml}
    `;

    content.appendChild(card);

    const timeDiv = document.createElement('div');
    timeDiv.className = 'signal-message-time';
    timeDiv.textContent = 'Just now';
    content.appendChild(timeDiv);

    messageDiv.appendChild(avatar);
    messageDiv.appendChild(content);
    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// Chat input handling
const chatInput = document.getElementById('chatInput');
if (chatInput) {
    chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && chatInput.value.trim()) {
            sendChatMessage(chatInput.value.trim());
            chatInput.value = '';
        }
    });
}

// ── BYOK: Read API keys from localStorage for per-request auth ──
function getBYOKHeaders() {
    const headers = { 'Content-Type': 'application/json' };
    const openaiKey = localStorage.getItem('scout_openai_key');
    const apifyToken = localStorage.getItem('scout_apify_token');
    const adminMode = localStorage.getItem('scout_admin_mode');
    if (openaiKey) headers['X-OpenAI-Key'] = openaiKey;
    if (apifyToken) headers['X-Apify-Token'] = apifyToken;
    if (adminMode === '1') headers['X-Admin-Mode'] = '1';
    return headers;
}

async function sendChatMessage(message) {
    // Add user message first
    addChatMessage(message, true);

    try {
        const response = await fetch('/chat/message', {
            method: 'POST',
            headers: getBYOKHeaders(),
            body: JSON.stringify({ message })
        });

        const data = await response.json();

        // Update currentVertical when chat creates/switches the active vertical
        // This ensures analysis-completion redirects always have the correct vertical
        if (data.context && data.context.active_vertical) {
            currentVertical = data.context.active_vertical;
        }

        // Handle analysis started - redirect with appropriate filter params
        if (data.analysis_started) {
            // Show the Scout's response first
            if (data.response) {
                addChatMessage(data.response, false);
            }

            // Build redirect URL with filter params to sync UI
            let redirectUrl = '/signal?analysis_started=true';

            // Include vertical name so the loading page knows which vertical to track
            const chatVertical = data.context && data.context.active_vertical;
            if (chatVertical) {
                redirectUrl += '&vertical=' + encodeURIComponent(chatVertical);
            } else if (currentVertical) {
                redirectUrl += '&vertical=' + encodeURIComponent(currentVertical);
            }

            // If specific brands selected, add competitor param (single brand only for now)
            if (data.selected_brands && data.selected_brands.length === 1) {
                redirectUrl += '&competitor=' + encodeURIComponent(data.selected_brands[0]);
            }

            // Include platform/timeframe preferences from chat
            if (data.filter_platform) {
                redirectUrl += '&platform=' + encodeURIComponent(data.filter_platform);
            }
            if (data.filter_timeframe) {
                redirectUrl += '&timeframe=' + encodeURIComponent(data.filter_timeframe);
            }

            // Small delay to let user see the message, then redirect
            setTimeout(() => {
                window.location.href = redirectUrl;
            }, 800);
            return;
        }

        // Handle filter actions from chatbot (Phase 4: chat→filter sync)
        if (data.filter_action && data.filter_brands && data.filter_brands.length > 0) {
            if (data.response) addChatMessage(data.response, false);
            applyFilter('competitor', data.filter_brands[0]);
            return;
        }
        if (data.filter_platform) {
            if (data.response) addChatMessage(data.response, false);
            applyFilter('platform', data.filter_platform);
            return;
        }
        if (data.filter_timeframe) {
            if (data.response) addChatMessage(data.response, false);
            applyFilter('timeframe', data.filter_timeframe);
            return;
        }
        if (data.filter_sort) {
            if (data.response) addChatMessage(data.response, false);
            applyFilter('sort', data.filter_sort);
            return;
        }

        // Handle different response types
        if (data.type === 'category_card') {
            addCategoryCard(data.response, data.data, data.actions);
        } else if (data.type === 'category_list') {
            addCategoryList(data.response, data.data);
        } else if (data.response) {
            addChatMessage(data.response, false);
        } else {
            addChatMessage("I'm not sure how to help with that. Try asking me to 'suggest brands' for a category, or type 'help' to see what I can do!", false);
        }
    } catch (error) {
        console.error('Chat error:', error);
        addChatMessage("Hmm, something went wrong. Here are some things you can try:\n• 'suggest streetwear brands' — get brand ideas\n• 'show categories' — see your collections\n• 'help' — see all commands", false);
    }
}

function formatChatText(text) {
    // Convert markdown-style formatting to HTML for chat bubbles
    let html = text
        // Escape HTML first
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        // Bold: **text**
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        // Inline code: `text`
        .replace(/`([^`]+)`/g, '<code style="background:rgba(0,255,255,0.1);padding:1px 5px;border-radius:3px;font-size:0.9em;">$1</code>')
        // Bullet points: • or - at start of line
        .replace(/^[•\-]\s+(.+)$/gm, '<div style="padding-left:12px;position:relative;margin:2px 0;"><span style="position:absolute;left:0;">•</span> $1</div>')
        // Newlines to breaks
        .replace(/\n/g, '<br>');
    return html;
}

function addChatMessage(text, isUser) {
    const messagesDiv = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = isUser ? 'signal-message signal-message-user' : 'signal-message';

    const avatar = document.createElement('div');
    avatar.className = 'signal-avatar';
    avatar.textContent = isUser ? 'U' : 'S';

    if (isUser) {
        avatar.style.background = 'var(--signal-cyan)';
        avatar.style.color = '#000';
    }

    const content = document.createElement('div');
    content.className = 'signal-message-content';

    const bubble = document.createElement('div');
    bubble.className = 'signal-message-bubble';

    if (isUser) {
        bubble.textContent = text;
        bubble.style.background = 'var(--signal-cyan-dim)';
        bubble.style.border = '1px solid var(--signal-cyan)';
        bubble.style.color = 'var(--signal-text-primary)';
    } else {
        bubble.innerHTML = formatChatText(text);
    }

    const timeDiv = document.createElement('div');
    timeDiv.className = 'signal-message-time';
    timeDiv.textContent = 'Just now';

    content.appendChild(bubble);
    content.appendChild(timeDiv);
    messageDiv.appendChild(avatar);
    messageDiv.appendChild(content);
    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function addCategoryCard(text, data, actions) {
    const messagesDiv = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'signal-message';

    const avatar = document.createElement('div');
    avatar.className = 'signal-avatar';
    avatar.textContent = 'S';

    const content = document.createElement('div');
    content.className = 'signal-message-content';

    // Text bubble
    const bubble = document.createElement('div');
    bubble.className = 'signal-message-bubble';
    bubble.textContent = text;
    content.appendChild(bubble);

    // Category card
    const card = document.createElement('div');
    card.className = 'signal-insight-card';
    card.style.marginTop = '12px';

    const header = document.createElement('div');
    header.className = 'signal-insight-header';
    header.innerHTML = `
        <span class="signal-insight-icon">📁</span>
        <span class="signal-insight-label">COLLECTION</span>
        <span class="signal-insight-metric">${data.brand_count} brand${data.brand_count !== 1 ? 's' : ''}</span>
    `;
    card.appendChild(header);

    const title = document.createElement('div');
    title.className = 'signal-insight-title';
    title.textContent = data.name;
    card.appendChild(title);

    const brandsDiv = document.createElement('div');
    brandsDiv.className = 'signal-insight-desc';
    brandsDiv.style.display = 'flex';
    brandsDiv.style.flexWrap = 'wrap';
    brandsDiv.style.gap = '8px';
    brandsDiv.style.marginTop = '12px';

    data.brands.forEach(handle => {
        const brandTag = document.createElement('span');
        brandTag.style.cssText = 'background: var(--signal-bg-tertiary); color: var(--signal-text-secondary); padding: 4px 10px; border-radius: 6px; font-size: 12px;';
        brandTag.textContent = handle;
        brandsDiv.appendChild(brandTag);
    });
    card.appendChild(brandsDiv);

    // Action buttons
    if (actions && actions.length > 0) {
        const actionsDiv = document.createElement('div');
        actionsDiv.style.cssText = 'display: flex; gap: 8px; margin-top: 12px;';

        actions.forEach(action => {
            const btn = document.createElement('button');
            btn.className = 'signal-pill';
            btn.textContent = action.label;
            btn.onclick = () => {
                if (action.action === 'run_analysis') {
                    sendChatMessage(`run analysis for ${action.category}`);
                } else if (action.action === 'add_brands') {
                    chatInput.value = `add @brand to ${action.category}`;
                    chatInput.focus();
                }
            };
            actionsDiv.appendChild(btn);
        });

        card.appendChild(actionsDiv);
    }

    content.appendChild(card);

    const timeDiv = document.createElement('div');
    timeDiv.className = 'signal-message-time';
    timeDiv.textContent = 'Just now';
    content.appendChild(timeDiv);

    messageDiv.appendChild(avatar);
    messageDiv.appendChild(content);
    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function addCategoryList(text, categories) {
    const messagesDiv = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'signal-message';

    const avatar = document.createElement('div');
    avatar.className = 'signal-avatar';
    avatar.textContent = 'S';

    const content = document.createElement('div');
    content.className = 'signal-message-content';

    const bubble = document.createElement('div');
    bubble.className = 'signal-message-bubble';
    bubble.textContent = text;
    content.appendChild(bubble);

    // Category list
    categories.forEach(cat => {
        const catCard = document.createElement('div');
        catCard.className = 'signal-insight-card';
        catCard.style.marginTop = '12px';
        catCard.style.cursor = 'pointer';
        catCard.onclick = () => sendChatMessage(`show ${cat.name}`);

        const header = document.createElement('div');
        header.className = 'signal-insight-header';
        header.innerHTML = `
            <span class="signal-insight-icon">📁</span>
            <span class="signal-insight-label">${cat.name.toUpperCase()}</span>
            <span class="signal-insight-metric">${cat.brand_count} brand${cat.brand_count !== 1 ? 's' : ''}</span>
        `;
        catCard.appendChild(header);

        content.appendChild(catCard);
    });

    const timeDiv = document.createElement('div');
    timeDiv.className = 'signal-message-time';
    timeDiv.textContent = 'Just now';
    content.appendChild(timeDiv);

    messageDiv.appendChild(avatar);
    messageDiv.appendChild(content);
    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// Auto-scroll messages
const messagesContainer = document.getElementById('chatMessages');
if (messagesContainer) {
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// Long-press handling for brand pills
let pressTimer = null;
let isLongPress = false;

function handleBrandClick(event, handle) {
    // Prevent action if it was a long press
    if (isLongPress) {
        isLongPress = false;
        return;
    }
    // Normal click - apply filter
    applyFilter('competitor', handle);
}

// Setup long-press handlers for all brand pills
document.addEventListener('DOMContentLoaded', () => {
    const brandPills = document.querySelectorAll('.brand-pill');

    brandPills.forEach(pill => {
        const handle = pill.dataset.handle;

        // Mouse events
        pill.addEventListener('mousedown', (e) => {
            startPress(pill, handle);
            e.preventDefault(); // Prevent text selection
        });

        pill.addEventListener('mouseup', () => {
            cancelPress(pill);
        });

        pill.addEventListener('mouseleave', () => {
            cancelPress(pill);
        });

        // Touch events for mobile
        pill.addEventListener('touchstart', (e) => {
            startPress(pill, handle);
        });

        pill.addEventListener('touchend', () => {
            cancelPress(pill);
        });

        pill.addEventListener('touchcancel', () => {
            cancelPress(pill);
        });
    });
});

function startPress(pill, handle) {
    pressTimer = setTimeout(() => {
        isLongPress = true;
        showBrandReplaceUI(pill, handle);
    }, 500); // 500ms for long press
}

function cancelPress(pill) {
    if (pressTimer) {
        clearTimeout(pressTimer);
        pressTimer = null;
    }
    pill.classList.remove('removing');
}

function showBrandReplaceUI(pill, currentHandle) {
    // Add removing state
    pill.classList.add('removing');

    // Show custom prompt to enter new handle
    showCustomPrompt(
        `Replace @${currentHandle}`,
        'Enter Instagram or TikTok handle (without @):',
        currentHandle,
        (newHandle) => {
            pill.classList.remove('removing');
            if (newHandle.trim() !== currentHandle) {
                // Redirect to manage page or update via API
                // For now, redirect to vertical edit page where they can manage brands
                window.location.href = `/verticals/{{ vertical_name }}/edit`;
            }
        }
    );
}

// Chat reset function
function resetChat() {
    // Navigate to empty state - clears all brands, chat, and posts
    window.location.href = window.location.pathname + '?empty=true';
}

// Toggle vertical dropdown menu
function toggleVerticalDropdown() {
    const menu = document.getElementById('verticalDropdownMenu');
    const isOpen = menu.classList.contains('open');

    // Close all other dropdowns first
    document.querySelectorAll('.signal-vertical-dropdown-menu').forEach(m => m.classList.remove('open'));

    // Toggle this dropdown
    if (!isOpen) {
        menu.classList.add('open');
    }
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
    const container = event.target.closest('.signal-vertical-dropdown-container');
    if (!container) {
        document.querySelectorAll('.signal-vertical-dropdown-menu').forEach(m => m.classList.remove('open'));
    }
});

// Load competitive set (vertical)
function loadVertical(verticalName) {
    if (verticalName) {
        window.location.href = `/api/load_vertical/${encodeURIComponent(verticalName)}`;
    }
}

// Delete competitive set
function deleteBrandFromSet(handle, verticalName, event) {
    event.stopPropagation(); // Prevent brand filter from applying

    showCustomConfirm(
        `Remove @${handle}?`,
        `This will remove @${handle} from "${verticalName}" competitive set.`,
        () => {
            // Create form and submit to remove brand
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/verticals/${verticalName}/brands/remove`;

            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'handle';
            input.value = handle;

            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
        }
    );
}

// Drag and drop functionality for brand pills
let draggedBrand = null;
let draggedVertical = null;

document.addEventListener('DOMContentLoaded', function() {
    // Add drag event listeners to all brand pills
    document.querySelectorAll('.brand-pill[draggable="true"]').forEach(pill => {
        pill.addEventListener('dragstart', handleDragStart);
        pill.addEventListener('dragend', handleDragEnd);
    });

    // Add drop zone event listeners
    const trashZone = document.getElementById('trash-zone');
    if (trashZone) {
        trashZone.addEventListener('dragover', handleDragOver);
        trashZone.addEventListener('dragleave', handleDragLeave);
        trashZone.addEventListener('drop', handleDrop);
    }
});

function handleDragStart(e) {
    draggedBrand = this.getAttribute('data-handle');
    draggedVertical = this.getAttribute('data-vertical');

    this.classList.add('dragging');

    // Show trash zone
    const trashZone = document.getElementById('trash-zone');
    if (trashZone) {
        trashZone.classList.add('visible');
    }

    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', this.innerHTML);
}

function handleDragEnd(e) {
    this.classList.remove('dragging');

    // Hide trash zone
    const trashZone = document.getElementById('trash-zone');
    if (trashZone) {
        trashZone.classList.remove('visible');
        trashZone.classList.remove('drag-over');
    }
}

function handleDragOver(e) {
    if (e.preventDefault) {
        e.preventDefault();
    }

    e.dataTransfer.dropEffect = 'move';
    this.classList.add('drag-over');

    return false;
}

function handleDragLeave(e) {
    this.classList.remove('drag-over');
}

function handleDrop(e) {
    if (e.stopPropagation) {
        e.stopPropagation();
    }

    this.classList.remove('drag-over');

    // Trigger deletion
    if (draggedBrand && draggedVertical) {
        showCustomConfirm(
            `Remove @${draggedBrand}?`,
            `This will remove @${draggedBrand} from "${draggedVertical}" competitive set.`,
            () => {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/verticals/${draggedVertical}/brands/remove`;

                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'handle';
                input.value = draggedBrand;

                form.appendChild(input);
                document.body.appendChild(form);
                form.submit();
            }
        );
    }

    return false;
}

function deleteVertical(verticalName, event) {
    event.stopPropagation(); // Prevent dropdown from closing

    showCustomConfirm(
        `Delete "${verticalName}"?`,
        'This will permanently remove this competitive set and all associated data. This action cannot be undone.',
        () => {
            // Create form and submit
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/verticals/delete';

            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'vertical_name';
            input.value = verticalName;

            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
        }
    );
}

// ── Custom Modal Functions ──

function showCustomConfirm(title, message, onConfirm) {
    const modal = document.getElementById('customConfirmModal');
    const titleEl = document.getElementById('confirmModalTitle');
    const messageEl = document.getElementById('confirmModalMessage');

    titleEl.textContent = title;
    messageEl.textContent = message;
    modal.style.display = 'flex';

    const confirmBtn = document.getElementById('confirmModalConfirm');
    const cancelBtn = document.getElementById('confirmModalCancel');

    const handleConfirm = () => {
        modal.style.display = 'none';
        confirmBtn.removeEventListener('click', handleConfirm);
        cancelBtn.removeEventListener('click', handleCancel);
        onConfirm();
    };

    const handleCancel = () => {
        modal.style.display = 'none';
        confirmBtn.removeEventListener('click', handleConfirm);
        cancelBtn.removeEventListener('click', handleCancel);
    };

    confirmBtn.addEventListener('click', handleConfirm);
    cancelBtn.addEventListener('click', handleCancel);
}

function showCustomPrompt(title, message, placeholder, onConfirm) {
    const modal = document.getElementById('customPromptModal');
    const titleEl = document.getElementById('promptModalTitle');
    const messageEl = document.getElementById('promptModalMessage');
    const inputEl = document.getElementById('promptModalInput');

    titleEl.textContent = title;
    messageEl.textContent = message;
    inputEl.placeholder = placeholder;
    inputEl.value = '';
    modal.style.display = 'flex';

    setTimeout(() => inputEl.focus(), 100);

    const confirmBtn = document.getElementById('promptModalConfirm');
    const cancelBtn = document.getElementById('promptModalCancel');

    const handleConfirm = () => {
        const value = inputEl.value.trim();
        modal.style.display = 'none';
        confirmBtn.removeEventListener('click', handleConfirm);
        cancelBtn.removeEventListener('click', handleCancel);
        inputEl.removeEventListener('keypress', handleKeypress);
        if (value) onConfirm(value);
    };

    const handleCancel = () => {
        modal.style.display = 'none';
        confirmBtn.removeEventListener('click', handleConfirm);
        cancelBtn.removeEventListener('click', handleCancel);
        inputEl.removeEventListener('keypress', handleKeypress);
    };

    const handleKeypress = (e) => {
        if (e.key === 'Enter') handleConfirm();
        if (e.key === 'Escape') handleCancel();
    };

    confirmBtn.addEventListener('click', handleConfirm);
    cancelBtn.addEventListener('click', handleCancel);
    inputEl.addEventListener('keypress', handleKeypress);
}
</script>

<!-- Custom Modals -->
<div id="customConfirmModal" class="custom-modal">
    <div class="custom-modal-content">
        <h3 id="confirmModalTitle">Confirm Action</h3>
        <p id="confirmModalMessage">Are you sure?</p>
        <div class="custom-modal-buttons">
            <button id="confirmModalCancel" class="custom-modal-btn custom-modal-btn-cancel">Cancel</button>
            <button id="confirmModalConfirm" class="custom-modal-btn custom-modal-btn-confirm">Confirm</button>
        </div>
    </div>
</div>

<div id="customPromptModal" class="custom-modal">
    <div class="custom-modal-content">
        <h3 id="promptModalTitle">Enter Value</h3>
        <p id="promptModalMessage">Please enter a value:</p>
        <input type="text" id="promptModalInput" class="custom-modal-input" />
        <div class="custom-modal-buttons">
            <button id="promptModalCancel" class="custom-modal-btn custom-modal-btn-cancel">Cancel</button>
            <button id="promptModalConfirm" class="custom-modal-btn custom-modal-btn-confirm">Confirm</button>
        </div>
    </div>
</div>

<!-- Analysis Loading Modal -->
<div id="analysisLoadingModal" class="custom-modal">
    <div class="custom-modal-content analysis-loading-content" style="position: relative;">
        <button type="button" class="signal-modal-close" onclick="cancelAnalysis()" style="position: absolute; top: 20px; right: 20px; z-index: 10;">×</button>
        <div class="analysis-loading-header">
            <div class="analysis-spinner"></div>
            <h3>Analyzing Content</h3>
        </div>
        <p id="analysisLoadingMessage">Collecting posts and analyzing engagement patterns...</p>
        <div class="analysis-progress-bar">
            <div id="analysisProgressFill" class="analysis-progress-fill"></div>
        </div>
        <div class="analysis-time-info">
            <p id="analysisTimeElapsed" class="analysis-time-detail">Elapsed: 0m 0s</p>
            <p id="analysisTimeEstimate" class="analysis-time-estimate">Remaining: 2-3 minutes</p>
        </div>
        <p class="analysis-loading-tip">Scout is working in the background. You'll see results automatically when ready.</p>
        <div style="margin-top: 20px; text-align: center;">
            <button onclick="cancelAnalysis()" class="custom-modal-btn custom-modal-btn-cancel" style="padding: 10px 24px;">
                Cancel Analysis
            </button>
        </div>
    </div>
</div>

<script>
// Analysis status polling
let analysisPollingInterval = null;
let analysisTimerInterval = null;
let analysisStartedAt = null;
let stallCheckCount = 0;
let lastProgressPct = -1;
let lastRemainingText = null;

function showAnalysisLoading() {
    const modal = document.getElementById('analysisLoadingModal');
    modal.style.display = 'flex';
    analysisStartedAt = Date.now();
    stallCheckCount = 0;
    lastProgressPct = -1;
    lastRemainingText = null;

    // Clear old outlier cards to prevent showing stale data
    const outlierGrid = document.querySelector('.signal-grid');
    if (outlierGrid) {
        outlierGrid.innerHTML = '<div class="signal-empty" style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; color: var(--signal-text-dim);">Analyzing content...</div>';
    }

    // Start client-side elapsed timer (updates every second for smooth display)
    if (!analysisTimerInterval) {
        analysisTimerInterval = setInterval(updateElapsedTimer, 1000);
    }

    // Start polling for analysis status
    if (!analysisPollingInterval) {
        analysisPollingInterval = setInterval(checkAnalysisStatus, 2500);
    }
}

function updateElapsedTimer() {
    if (!analysisStartedAt) return;
    const elapsed = Math.floor((Date.now() - analysisStartedAt) / 1000);
    const mins = Math.floor(elapsed / 60);
    const secs = elapsed % 60;
    const el = document.getElementById('analysisTimeElapsed');
    if (el) el.textContent = `Elapsed: ${mins}m ${secs}s`;
}

function hideAnalysisLoading() {
    const modal = document.getElementById('analysisLoadingModal');
    modal.style.display = 'none';

    if (analysisPollingInterval) {
        clearInterval(analysisPollingInterval);
        analysisPollingInterval = null;
    }
    if (analysisTimerInterval) {
        clearInterval(analysisTimerInterval);
        analysisTimerInterval = null;
    }
    analysisStartedAt = null;
}

function checkAnalysisStatus() {
    fetch('/analysis/status')
        .then(response => response.json())
        .then(data => {
            const progressFill = document.getElementById('analysisProgressFill');
            const messageEl = document.getElementById('analysisLoadingMessage');
            const timeRemainingEl = document.getElementById('analysisTimeEstimate');

            if (data.is_running) {
                stallCheckCount = 0;  // Reset stall counter — server says it's running

                if (data.progress !== undefined && data.progress > lastProgressPct) {
                    // Only advance forward — never let the bar shrink
                    progressFill.style.width = data.progress + '%';
                    lastProgressPct = data.progress;
                }

                if (data.message) {
                    messageEl.textContent = data.message;
                }

                if (data.time_remaining && data.time_remaining !== 'Starting...') {
                    // Parse seconds from "Xm Ys" for comparison
                    const parseRemaining = (s) => {
                        const m = s.match(/(\d+)m\s*(\d+)s/);
                        return m ? parseInt(m[1]) * 60 + parseInt(m[2]) : Infinity;
                    };
                    const newSecs = parseRemaining(data.time_remaining);
                    const prevSecs = lastRemainingText ? parseRemaining(lastRemainingText) : Infinity;
                    // Only show if it decreased or is the first estimate
                    if (newSecs <= prevSecs || !lastRemainingText) {
                        lastRemainingText = data.time_remaining;
                    }
                    timeRemainingEl.textContent = 'Remaining: ' + lastRemainingText;
                } else if (data.time_remaining) {
                    timeRemainingEl.textContent = 'Remaining: ' + data.time_remaining;
                } else {
                    timeRemainingEl.textContent = 'Remaining: estimating...';
                }
            } else if (data.completed) {
                // Analysis completed — refresh to show results
                hideAnalysisLoading();
                window.location.href = '/signal' + (currentVertical ? '?vertical=' + encodeURIComponent(currentVertical) : '');
            } else if (data.error) {
                hideAnalysisLoading();
                addChatMessage('Analysis failed: ' + data.error, false);
            } else {
                // Neither running nor completed — might be a gap between start and PID write
                stallCheckCount++;
                if (stallCheckCount > 8) {
                    // 8 polls (~20s) with no running/completed — treat as done
                    hideAnalysisLoading();
                    window.location.href = '/signal' + (currentVertical ? '?vertical=' + encodeURIComponent(currentVertical) : '');
                }
            }
        })
        .catch(error => {
            console.error('Error checking analysis status:', error);
            stallCheckCount++;
            if (stallCheckCount > 12) {
                // Network failures for 30s — give up gracefully
                hideAnalysisLoading();
                window.location.href = '/signal' + (currentVertical ? '?vertical=' + encodeURIComponent(currentVertical) : '');
            }
        });
}

// Cancel analysis function
function cancelAnalysis() {
    fetch('/analysis/cancel', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            hideAnalysisLoading();
            if (data.success) {
                // Refresh page to show current state
                window.location.href = '/signal' + (currentVertical ? '?vertical=' + encodeURIComponent(currentVertical) : '');
            } else {
                alert('Failed to cancel analysis: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error canceling analysis:', error);
            alert('Failed to cancel analysis');
        });
}

// Check if analysis was just started (from chat context)
window.addEventListener('DOMContentLoaded', function() {
    // If we detect analysis_started in the page context, show loading
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('analysis_started') === 'true') {
        showAnalysisLoading();
    }

    // Scroll chat to bottom on load so the most recent messages are visible
    // (important when chat history is re-rendered from session on page reload)
    const messagesDiv = document.getElementById('chatMessages');
    if (messagesDiv) {
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
});

// ========================================
// SPLASH SCREEN CONTROLLER
// ========================================

(function() {
    const SPLASH_DURATION = 4000; // 4.0 seconds

    // Get user-specific key for localStorage (includes email if available)
    function getSplashKey() {
        {% if auth_enabled and current_user %}
        return 'scoutai_splash_shown_{{ current_user.email }}';
        {% else %}
        return 'scoutai_splash_shown';
        {% endif %}
    }

    function shouldShowSplash() {
        // Check if user came from browser back button
        if (window.performance && window.performance.navigation.type === 2) {
            return false; // Don't show on back button
        }

        // Check if we already showed the splash for this user (persists across sessions)
        const splashShown = localStorage.getItem(getSplashKey());
        return !splashShown;
    }

    function showSplash() {
        const splash = document.getElementById('splashScreen');
        if (!splash) return;

        // Show splash immediately
        splash.style.display = 'flex';

        // Mark as shown in localStorage (persists across sessions until logout)
        localStorage.setItem(getSplashKey(), 'true');

        // Hide after duration
        setTimeout(function() {
            splash.classList.add('fade-out');

            // Remove from DOM after animation completes
            setTimeout(function() {
                splash.style.display = 'none';
            }, 600); // Match CSS transition duration
        }, SPLASH_DURATION);
    }

    // Clear splash flag on logout
    window.clearSplashOnLogout = function() {
        localStorage.removeItem(getSplashKey());
    };

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        if (shouldShowSplash()) {
            showSplash();
        }
    });
})();
</script>

</body>
</html>
