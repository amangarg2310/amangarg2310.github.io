{% extends "base.html" %}
{% block title %}Chat with Scout{% endblock %}
{% block page_title %}Scout{% endblock %}
{% block page_subtitle %}Your AI content intelligence assistant{% endblock %}

{% block content %}

<style>
.chat-container {
    max-width: 800px;
    margin: 0 auto;
    height: calc(100vh - 280px);
    min-height: 500px;
    display: flex;
    flex-direction: column;
    background: var(--bg-secondary);
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid var(--border);
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 24px;
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.chat-message {
    display: flex;
    gap: 12px;
    max-width: 85%;
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.chat-message.user {
    margin-left: auto;
    flex-direction: row-reverse;
}

.message-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    flex-shrink: 0;
    font-size: 14px;
}

.message-avatar.assistant {
    background: linear-gradient(135deg, var(--accent), #00d4ff);
    color: white;
}

.message-avatar.user {
    background: var(--bg-tertiary);
    color: var(--text);
}

.message-content {
    background: var(--bg);
    padding: 12px 16px;
    border-radius: 12px;
    border: 1px solid var(--border);
}

.chat-message.user .message-content {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
}

.message-content p {
    margin: 0;
    line-height: 1.6;
    font-size: 14px;
}

.message-content strong {
    font-weight: 600;
}

.message-content ul {
    margin: 8px 0;
    padding-left: 20px;
}

.typing-indicator {
    display: none;
    gap: 12px;
    max-width: 85%;
}

.typing-indicator.active {
    display: flex;
}

.typing-dots {
    background: var(--bg);
    padding: 12px 16px;
    border-radius: 12px;
    border: 1px solid var(--border);
    display: flex;
    gap: 4px;
}

.typing-dots span {
    width: 8px;
    height: 8px;
    background: var(--text-dim);
    border-radius: 50%;
    animation: typing 1.4s infinite;
}

.typing-dots span:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-dots span:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes typing {
    0%, 60%, 100% { opacity: 0.3; transform: translateY(0); }
    30% { opacity: 1; transform: translateY(-6px); }
}

.chat-input-container {
    padding: 16px;
    border-top: 1px solid var(--border);
    background: var(--bg);
}

.chat-input-wrapper {
    display: flex;
    gap: 12px;
    align-items: center;
}

.chat-input {
    flex: 1;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 24px;
    padding: 12px 20px;
    color: var(--text);
    font-size: 14px;
    outline: none;
    transition: border-color 0.2s;
}

.chat-input:focus {
    border-color: var(--accent);
}

.chat-input::placeholder {
    color: var(--text-dim);
}

.send-button {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: var(--accent);
    border: none;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    flex-shrink: 0;
}

.send-button:hover {
    background: #00b8d9;
    transform: scale(1.05);
}

.send-button:active {
    transform: scale(0.95);
}

.send-button:disabled {
    background: var(--bg-tertiary);
    cursor: not-allowed;
    transform: none;
}

.welcome-message {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-secondary);
}

.welcome-message h3 {
    font-size: 20px;
    margin-bottom: 12px;
    color: var(--text);
}

.welcome-message p {
    font-size: 14px;
    line-height: 1.6;
    margin-bottom: 24px;
}

.quick-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: center;
}

.quick-action {
    background: var(--bg);
    border: 1px solid var(--border);
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 13px;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.2s;
}

.quick-action:hover {
    border-color: var(--accent);
    color: var(--accent);
}

/* Markdown-style formatting in messages */
.message-content code {
    background: var(--bg-tertiary);
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 12px;
    font-family: 'SF Mono', Monaco, monospace;
}

.chat-message.user .message-content code {
    background: rgba(255,255,255,0.2);
}

/* Analysis progress indicator */
.spinner {
    width: 16px;
    height: 16px;
    border: 2px solid var(--bg-tertiary);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.dots::after {
    content: '';
    animation: dots 1.5s steps(4, end) infinite;
}

@keyframes dots {
    0%, 20% { content: ''; }
    40% { content: '.'; }
    60% { content: '..'; }
    80%, 100% { content: '...'; }
}
</style>

<div class="chat-container">
    <div class="chat-messages" id="chatMessages">
        <div class="welcome-message">
            <div style="font-size: 48px; margin-bottom: 16px;">üîç</div>
            <h3>Hey! I'm Scout</h3>
            <p>I help you find posts that are crushing it on social media.<br>
            What brands do you want to track?</p>

            <div class="quick-actions">
                <div class="quick-action" onclick="sendQuickAction('track streetwear brands')">Track Streetwear</div>
                <div class="quick-action" onclick="sendQuickAction('help')">How does this work?</div>
            </div>
        </div>
    </div>

    <!-- Typing indicator -->
    <div class="typing-indicator" id="typingIndicator">
        <div class="message-avatar assistant">S</div>
        <div class="typing-dots">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </div>

    <div class="chat-input-container">
        <div class="chat-input-wrapper">
            <input
                type="text"
                class="chat-input"
                id="chatInput"
                placeholder="Type a message... (e.g., 'track sneaker brands')"
                autocomplete="off"
            >
            <button class="send-button" id="sendButton">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');
const sendButton = document.getElementById('sendButton');
const typingIndicator = document.getElementById('typingIndicator');

// Auto-scroll to bottom
function scrollToBottom() {
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Add message to chat
function addMessage(text, isUser = false) {
    // Remove welcome message on first interaction
    const welcomeMsg = chatMessages.querySelector('.welcome-message');
    if (welcomeMsg) {
        welcomeMsg.remove();
    }

    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${isUser ? 'user' : 'assistant'}`;

    const avatar = document.createElement('div');
    avatar.className = `message-avatar ${isUser ? 'user' : 'assistant'}`;
    avatar.textContent = isUser ? 'Y' : 'S';  // Y for "You", S for "Scout"

    const content = document.createElement('div');
    content.className = 'message-content';

    // Parse markdown-like formatting
    let formattedText = text
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\n/g, '<br>');

    content.innerHTML = formattedText;

    messageDiv.appendChild(avatar);
    messageDiv.appendChild(content);

    chatMessages.appendChild(messageDiv);
    scrollToBottom();
}

// Show/hide typing indicator
function setTyping(isTyping) {
    if (isTyping) {
        typingIndicator.classList.add('active');
        scrollToBottom();
    } else {
        typingIndicator.classList.remove('active');
    }
}

// Send message to server
async function sendMessage(message) {
    if (!message.trim()) return;

    // Add user message to UI
    addMessage(message, true);
    chatInput.value = '';
    chatInput.disabled = true;
    sendButton.disabled = true;

    // Show typing indicator
    setTyping(true);

    try {
        const response = await fetch('/chat/message', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ message }),
        });

        const data = await response.json();
        console.log('Scout response:', data);  // Debug logging

        // Check for errors
        if (!response.ok || data.error) {
            console.error('Server error:', data.error || response.statusText);
            throw new Error(data.error || 'Server error');
        }

        // Hide typing indicator
        setTyping(false);

        // Add Scout's response
        if (data.response) {
            addMessage(data.response, false);
        }

        // If analysis started, show loading indicator and poll for completion
        if (data.analysis_started) {
            console.log('Analysis started, showing progress indicator');
            showAnalysisProgress();
        }

    } catch (error) {
        console.error('Chat error:', error);  // Debug logging
        setTyping(false);
        addMessage('Oops, something went wrong. Please try again!', false);
    } finally {
        chatInput.disabled = false;
        sendButton.disabled = false;
        chatInput.focus();
    }
}

// Show analysis progress indicator
function showAnalysisProgress() {
    const progressDiv = document.createElement('div');
    progressDiv.className = 'chat-message assistant analysis-progress';
    progressDiv.id = 'analysisProgress';

    const avatar = document.createElement('div');
    avatar.className = 'message-avatar assistant';
    avatar.textContent = 'S';

    const content = document.createElement('div');
    content.className = 'message-content';
    content.innerHTML = `
        <div style="display: flex; align-items: center; gap: 12px;">
            <div class="spinner"></div>
            <span>Analysis running<span class="dots"></span></span>
        </div>
    `;

    progressDiv.appendChild(avatar);
    progressDiv.appendChild(content);
    chatMessages.appendChild(progressDiv);
    scrollToBottom();

    // Poll for completion
    console.log('Starting analysis status polling...');
    const pollInterval = setInterval(async () => {
        try {
            const response = await fetch('/analysis/status');
            const data = await response.json();
            console.log('Analysis status check:', data);

            if (!data.running) {
                console.log('Analysis completed!', data);
                clearInterval(pollInterval);
                // Remove progress indicator
                progressDiv.remove();
                // Add completion message with outliers count
                let message = 'Analysis complete! ';
                if (data.outliers_count && data.outliers_count > 0) {
                    message += `Found **${data.outliers_count} outlier posts**! `;
                }
                message += 'Head over to the **Outliers** page to see the results.';
                addMessage(message, false);
            }
        } catch (error) {
            console.error('Error checking analysis status:', error);
        }
    }, 3000); // Check every 3 seconds

    // Stop polling after 5 minutes
    setTimeout(() => {
        console.log('Analysis polling timeout reached (5 minutes)');
        clearInterval(pollInterval);
        if (document.getElementById('analysisProgress')) {
            progressDiv.remove();
            addMessage('Analysis is taking longer than expected. Check the Outliers page in a few minutes!', false);
        }
    }, 300000);
}

// Quick action handler
function sendQuickAction(message) {
    chatInput.value = message;
    sendMessage(message);
}

// Event listeners
sendButton.addEventListener('click', () => {
    sendMessage(chatInput.value);
});

chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        sendMessage(chatInput.value);
    }
});

// Focus input on load
chatInput.focus();
</script>
{% endblock %}
